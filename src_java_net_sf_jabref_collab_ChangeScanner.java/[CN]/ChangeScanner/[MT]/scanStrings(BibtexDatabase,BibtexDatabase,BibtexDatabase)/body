{
  int nTmp=onTmp.getStringCount(), nDisk=onDisk.getStringCount();
  if ((nTmp == 0) && (nDisk == 0))   return;
  HashSet<Object> used=new HashSet<Object>();
  HashSet<Object> usedInMem=new HashSet<Object>();
  HashSet<String> notMatched=new HashSet<String>(onTmp.getStringCount());
  mainLoop:   for (  String key : onTmp.getStringKeySet()) {
    BibtexString tmp=onTmp.getString(key);
    for (    String diskId : onDisk.getStringKeySet()) {
      if (!used.contains(diskId)) {
        BibtexString disk=onDisk.getString(diskId);
        if (disk.getName().equals(tmp.getName())) {
          if ((tmp.getContent() != null) && !tmp.getContent().equals(disk.getContent())) {
            BibtexString mem=findString(inMem,tmp.getName(),usedInMem);
            if (mem != null)             changes.add(new StringChange(mem,tmp,tmp.getName(),mem.getContent(),tmp.getContent(),disk.getContent()));
 else             changes.add(new StringChange(null,tmp,tmp.getName(),null,tmp.getContent(),disk.getContent()));
          }
          used.add(diskId);
          continue mainLoop;
        }
      }
    }
    notMatched.add(tmp.getId());
  }
  if (notMatched.size() > 0) {
    for (Iterator<String> i=notMatched.iterator(); i.hasNext(); ) {
      BibtexString tmp=onTmp.getString(i.next());
      for (      String diskId : onDisk.getStringKeySet()) {
        if (!used.contains(diskId)) {
          BibtexString disk=onDisk.getString(diskId);
          if (disk.getContent().equals(tmp.getContent())) {
            BibtexString bsMem=null;
            for (            String memId : inMem.getStringKeySet()) {
              BibtexString bsMem_cand=inMem.getString(memId);
              if (bsMem_cand.getContent().equals(disk.getContent()) && !usedInMem.contains(memId)) {
                usedInMem.add(memId);
                bsMem=bsMem_cand;
                break;
              }
            }
            changes.add(new StringNameChange(bsMem,tmp,bsMem.getName(),tmp.getName(),disk.getName(),tmp.getContent()));
            i.remove();
            used.add(diskId);
          }
        }
      }
    }
  }
  if (notMatched.size() > 0) {
    for (Iterator<String> i=notMatched.iterator(); i.hasNext(); ) {
      String nmId=i.next();
      BibtexString tmp=onTmp.getString(nmId);
      BibtexString mem=findString(inMem,tmp.getName(),usedInMem);
      if (mem != null) {
        changes.add(new StringRemoveChange(tmp,tmp,mem));
      }
    }
  }
  for (Iterator<String> i=onDisk.getStringKeySet().iterator(); i.hasNext(); ) {
    String diskId=i.next();
    if (!used.contains(diskId)) {
      BibtexString disk=onDisk.getString(diskId);
      used.add(diskId);
      changes.add(new StringAddChange(disk));
    }
  }
}
