{
  this.frame=frame;
  this.panel=panel;
  this.metaData=(panel == null) ? new MetaData() : panel.getLoadedDatabase().getMetaData();
  this.fields=Arrays.copyOf(fields,fields.length);
  this.undoName=undoName;
  this.newDatabase=newDatabase;
  preview=new PreviewPanel(null,metaData,Globals.prefs.get(JabRefPreferences.PREVIEW_0));
  duplLabel.setToolTipText(Localization.lang("Possible duplicate of existing entry. Click to resolve."));
  sortedList=new SortedList<>(entries);
  DefaultEventTableModel<BibEntry> tableModelGl=(DefaultEventTableModel<BibEntry>)GlazedListsSwing.eventTableModelWithThreadProxyList(sortedList,new EntryTableFormat());
  glTable=new EntryTable(tableModelGl);
  GeneralRenderer renderer=new GeneralRenderer(Color.white);
  glTable.setDefaultRenderer(JLabel.class,renderer);
  glTable.setDefaultRenderer(String.class,renderer);
  glTable.getInputMap().put(Globals.getKeyPrefs().getKey(KeyBinding.DELETE_ENTRY),"delete");
  DeleteListener deleteListener=new DeleteListener();
  glTable.getActionMap().put("delete",deleteListener);
  selectionModel=(DefaultEventSelectionModel<BibEntry>)GlazedListsSwing.eventSelectionModelWithThreadProxyList(sortedList);
  glTable.setSelectionModel(selectionModel);
  selectionModel.getSelected().addListEventListener(new EntrySelectionListener());
  comparatorChooser=TableComparatorChooser.install(glTable,sortedList,AbstractTableComparatorChooser.MULTIPLE_COLUMN_KEYBOARD);
  setupComparatorChooser();
  glTable.addMouseListener(new TableClickListener());
  setWidths();
  getContentPane().setLayout(new BorderLayout());
  progressBar.setIndeterminate(true);
  JPanel centerPan=new JPanel();
  centerPan.setLayout(new BorderLayout());
  contentPane.setTopComponent(new JScrollPane(glTable));
  contentPane.setBottomComponent(preview);
  centerPan.add(contentPane,BorderLayout.CENTER);
  centerPan.add(progressBar,BorderLayout.SOUTH);
  popup.add(deleteListener);
  popup.addSeparator();
  if (!newDatabase) {
    GroupTreeNode node=metaData.getGroups();
    JMenu groupsAdd=new JMenu(Localization.lang("Add to group"));
    groupsAdd.setEnabled(false);
    insertNodes(groupsAdd,node);
    popup.add(groupsAdd);
  }
  popup.add(new LinkLocalFile());
  popup.add(new DownloadFile());
  popup.add(new AutoSetLinks());
  popup.add(new AttachUrl());
  getContentPane().add(centerPan,BorderLayout.CENTER);
  ButtonBarBuilder bb=new ButtonBarBuilder();
  bb.addGlue();
  bb.addButton(ok);
  bb.addButton(stop);
  JButton cancel=new JButton(Localization.lang("Cancel"));
  bb.addButton(cancel);
  bb.addRelatedGap();
  JButton help=new HelpAction(HelpFiles.importInspectionHelp).getHelpButton();
  bb.addButton(help);
  bb.addGlue();
  bb.getPanel().setBorder(BorderFactory.createEmptyBorder(2,2,2,2));
  ButtonStackBuilder builder=new ButtonStackBuilder();
  JButton selectAll=new JButton(Localization.lang("Select all"));
  builder.addButton(selectAll);
  JButton deselectAll=new JButton(Localization.lang("Deselect all"));
  builder.addButton(deselectAll);
  builder.addButton(deselectAllDuplicates);
  builder.addRelatedGap();
  JButton delete=new JButton(Localization.lang("Delete"));
  builder.addButton(delete);
  builder.addRelatedGap();
  builder.addFixed(autoGenerate);
  builder.addButton(generate);
  builder.getPanel().setBorder(BorderFactory.createEmptyBorder(2,2,2,2));
  centerPan.add(builder.getPanel(),BorderLayout.WEST);
  ok.setEnabled(false);
  generate.setEnabled(false);
  ok.addActionListener(new OkListener());
  cancel.addActionListener(new CancelListener());
  generate.addActionListener(new GenerateListener());
  stop.addActionListener(new StopListener());
  selectAll.addActionListener(new SelectionButton(true));
  deselectAll.addActionListener(new SelectionButton(false));
  deselectAllDuplicates.addActionListener(new DeselectDuplicatesButtonListener());
  deselectAllDuplicates.setEnabled(false);
  delete.addActionListener(deleteListener);
  getContentPane().add(bb.getPanel(),BorderLayout.SOUTH);
  setSize(new Dimension(Globals.prefs.getInt(JabRefPreferences.IMPORT_INSPECTION_DIALOG_WIDTH),Globals.prefs.getInt(JabRefPreferences.IMPORT_INSPECTION_DIALOG_HEIGHT)));
  addWindowListener(new WindowAdapter(){
    @Override public void windowOpened(    WindowEvent e){
      contentPane.setDividerLocation(0.5f);
    }
    @Override public void windowClosed(    WindowEvent e){
      Globals.prefs.putInt(JabRefPreferences.IMPORT_INSPECTION_DIALOG_WIDTH,getSize().width);
      Globals.prefs.putInt(JabRefPreferences.IMPORT_INSPECTION_DIALOG_HEIGHT,getSize().height);
    }
  }
);
  AbstractAction closeAction=new AbstractAction(){
    @Override public void actionPerformed(    ActionEvent e){
      dispose();
    }
  }
;
  ActionMap am=contentPane.getActionMap();
  InputMap im=contentPane.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);
  im.put(Globals.getKeyPrefs().getKey(KeyBinding.CLOSE_DIALOG),"close");
  am.put("close",closeAction);
}
