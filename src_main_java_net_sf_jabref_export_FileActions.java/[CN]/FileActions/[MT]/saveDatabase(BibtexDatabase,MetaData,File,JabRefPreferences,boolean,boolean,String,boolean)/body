{
  TreeMap<String,BibtexEntryType> types=new TreeMap<String,BibtexEntryType>();
  boolean backup=prefs.getBoolean("backup");
  if (suppressBackup) {
    backup=false;
  }
  SaveSession session;
  BibtexEntry exceptionCause=null;
  try {
    session=new SaveSession(file,encoding,backup);
  }
 catch (  Throwable e) {
    if (encoding != null) {
      System.err.println("Error from encoding: '" + encoding + "' Len: "+ encoding.length());
    }
    e.printStackTrace();
    throw new SaveException(e.getMessage());
  }
  try {
    VerifyingWriter fw=session.getWriter();
    FileActions.writeBibFileHeader(fw,encoding);
    FileActions.writePreamble(fw,database.getPreamble());
    FileActions.writeStrings(fw,database);
    List<BibtexEntry> sorter=FileActions.getSortedEntries(database,metaData,null,true);
    BibtexEntryWriter bibtexEntryWriter=new BibtexEntryWriter(new LatexFieldFormatter(),true);
    for (    BibtexEntry be : sorter) {
      exceptionCause=be;
      BibtexEntryType tp=be.getType();
      if (BibtexEntryType.getStandardType(tp.getName()) == null) {
        types.put(tp.getName(),tp);
      }
      boolean write=true;
      if (checkSearch && !FileActions.nonZeroField(be,BibtexFields.SEARCH)) {
        write=false;
      }
      if (checkGroup && !FileActions.nonZeroField(be,BibtexFields.GROUPSEARCH)) {
        write=false;
      }
      if (write) {
        bibtexEntryWriter.write(be,fw);
        fw.write(Globals.NEWLINE);
      }
    }
    if (metaData != null) {
      metaData.writeMetaData(fw);
    }
    if (types.size() > 0) {
      for (      Map.Entry<String,BibtexEntryType> stringBibtexEntryTypeEntry : types.entrySet()) {
        BibtexEntryType type=stringBibtexEntryTypeEntry.getValue();
        if (type instanceof CustomEntryType) {
          CustomEntryType tp=(CustomEntryType)type;
          tp.save(fw);
          fw.write(Globals.NEWLINE);
        }
      }
    }
    fw.close();
  }
 catch (  Throwable ex) {
    ex.printStackTrace();
    session.cancel();
    throw new SaveException(ex.getMessage(),exceptionCause);
  }
  return session;
}
