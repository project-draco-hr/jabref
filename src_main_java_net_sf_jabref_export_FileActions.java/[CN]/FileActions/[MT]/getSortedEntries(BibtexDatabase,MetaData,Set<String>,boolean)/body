{
  boolean inOriginalOrder;
  if (isSaveOperation) {
    Vector<String> storedSaveOrderConfig=metaData.getData(net.sf.jabref.gui.DatabasePropertiesDialog.SAVE_ORDER_CONFIG);
    if (storedSaveOrderConfig == null) {
      inOriginalOrder=Globals.prefs.getBoolean(JabRefPreferences.SAVE_IN_ORIGINAL_ORDER);
    }
 else {
      SaveOrderConfig saveOrderConfig=new SaveOrderConfig(storedSaveOrderConfig);
      inOriginalOrder=saveOrderConfig.saveInOriginalOrder;
    }
  }
 else {
    inOriginalOrder=Globals.prefs.getBoolean(JabRefPreferences.EXPORT_IN_ORIGINAL_ORDER);
  }
  List<Comparator<BibtexEntry>> comparators;
  if (inOriginalOrder) {
    comparators=new ArrayList<>();
    comparators.add(new CrossRefEntryComparator());
    comparators.add(new IdComparator());
  }
 else {
    comparators=FileActions.getSaveComparators(isSaveOperation,metaData);
  }
  FieldComparatorStack<BibtexEntry> comparatorStack=new FieldComparatorStack<>(comparators);
  List<BibtexEntry> sorter=new ArrayList<>();
  if (keySet == null) {
    keySet=database.getKeySet();
  }
  if (keySet != null) {
    Iterator<String> i=keySet.iterator();
    for (; i.hasNext(); ) {
      sorter.add(database.getEntryById(i.next()));
    }
  }
  Collections.sort(sorter,comparatorStack);
  return sorter;
}
