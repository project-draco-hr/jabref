{
  if (Globals.prefs.getBoolean("warnAboutDuplicatesInInspection")) {
    for (int i=0; i < tableModel.getRowCount(); i++) {
      if (tableModel.getValueAt(i,DUPL_COL) != null) {
        CheckBoxMessage cbm=new CheckBoxMessage(Globals.lang("There are possible duplicates (marked with a 'D' icon) that haven't been resolved. Continue?"),Globals.lang("Disable this confirmation dialog"),false);
        int answer=JOptionPane.showConfirmDialog(ImportInspectionDialog.this,cbm,Globals.lang("Duplicates found"),JOptionPane.YES_NO_OPTION);
        if (cbm.isSelected())         Globals.prefs.putBoolean("warnAboutDuplicatesInInspection",false);
        if (answer == JOptionPane.NO_OPTION)         return;
        break;
      }
    }
  }
  NamedCompound ce=new NamedCompound(undoName);
  if (entriesToDelete.size() > 0) {
    for (Iterator i=entriesToDelete.iterator(); i.hasNext(); ) {
      BibtexEntry entry=(BibtexEntry)i.next();
      ce.addEdit(new UndoableRemoveEntry(panel.database(),entry,panel));
      panel.database().removeEntry(entry.getId());
    }
  }
  if (autoGenerate.isSelected() && !generatedKeys) {
    generateKeys(false);
  }
  Globals.prefs.putBoolean("generateKeysAfterInspection",autoGenerate.isSelected());
  final List selected=getSelectedEntries();
  if (selected.size() > 0) {
    if (newDatabase) {
      BibtexDatabase base=new BibtexDatabase();
      panel=new BasePanel(frame,base,null,new HashMap(),Globals.prefs);
    }
    boolean groupingCanceled=false;
    for (Iterator i=selected.iterator(); i.hasNext(); ) {
      BibtexEntry entry=(BibtexEntry)i.next();
      Set groups=(Set)groupAdditions.get(entry);
      if (!groupingCanceled && (groups != null)) {
        if (entry.getField(Globals.KEY_FIELD) == null) {
          int answer=JOptionPane.showConfirmDialog(ImportInspectionDialog.this,Globals.lang("Cannot add entries to group without generating keys. Generate keys now?"),Globals.lang("Add to group"),JOptionPane.YES_NO_OPTION);
          if (answer == JOptionPane.YES_OPTION) {
            generateKeys(false);
          }
 else           groupingCanceled=true;
        }
        if (entry.getField(Globals.KEY_FIELD) != null) {
          for (Iterator i2=groups.iterator(); i2.hasNext(); ) {
            GroupTreeNode node=(GroupTreeNode)i2.next();
            if (node.getGroup().supportsAdd()) {
              AbstractUndoableEdit undo=node.getGroup().add(new BibtexEntry[]{entry});
              if (undo instanceof UndoableChangeAssignment)               ((UndoableChangeAssignment)undo).setEditedNode(node);
              ce.addEdit(undo);
            }
 else {
            }
          }
        }
      }
      try {
        entry.setId(Util.createNeutralId());
        panel.database().insertEntry(entry);
        ce.addEdit(new UndoableInsertEntry(panel.database(),entry,panel));
      }
 catch (      KeyCollisionException e) {
        e.printStackTrace();
      }
    }
    ce.end();
    panel.undoManager.addEdit(ce);
  }
  dispose();
  SwingUtilities.invokeLater(new Thread(){
    public void run(){
      if (newDatabase) {
        frame.addTab(panel,null,true);
      }
      panel.markBaseChanged();
      panel.refreshTable();
      for (Iterator i=callBacks.iterator(); i.hasNext(); ) {
        ((CallBack)i.next()).done(selected.size());
      }
    }
  }
);
}
