{
  if (file == null) {
    return;
  }
  if (backup && Files.exists(file)) {
    Path fileName=file.getFileName();
    Path backupFile=file.resolveSibling(fileName + BACKUP_EXTENSION);
    try {
      FileUtil.copyFile(file.toFile(),backupFile.toFile(),true);
    }
 catch (    IOException ex) {
      LOGGER.error("Problem copying file",ex);
      throw SaveException.BACKUP_CREATION;
    }
  }
  try {
    if (useLockFile) {
      try {
        if (FileBasedLock.createLockFile(file)) {
          if (!FileBasedLock.waitForFileLock(file,10)) {
            throw SaveException.FILE_LOCKED;
          }
        }
      }
 catch (      IOException ex) {
        LOGGER.error("Error when creating lock file.",ex);
      }
    }
    FileUtil.copyFile(temporaryFile.toFile(),file.toFile(),true);
  }
 catch (  IOException ex2) {
    throw new SaveException("Save failed while committing changes: " + ex2.getMessage(),Localization.lang("Save failed while committing changes: %0",ex2.getMessage()));
  }
 finally {
    if (useLockFile) {
      FileBasedLock.deleteLockFile(file);
    }
  }
  try {
    Files.delete(temporaryFile);
  }
 catch (  IOException e) {
    LOGGER.warn("Cannot delete temporary file",e);
  }
}
