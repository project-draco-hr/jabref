{
  sb.append(valueDelimitersZero);
  boolean escape=false;
  boolean inCommandName=false;
  boolean inCommand=false;
  boolean inCommandOption=false;
  int nestedEnvironments=0;
  StringBuilder commandName=new StringBuilder();
  char c;
  for (int i=start_pos; i < end_pos; i++) {
    c=text.charAt(i);
    if (Character.isLetter(c) && (escape || inCommandName)) {
      inCommandName=true;
      if (!inCommandOption) {
        commandName.append(c);
      }
    }
 else     if (Character.isWhitespace(c) && (inCommand || inCommandOption)) {
    }
 else     if (inCommandName) {
      if (c == '[') {
        inCommandOption=true;
      }
 else       if (inCommandOption && c == ']') {
        inCommandOption=false;
      }
 else       if (!inCommandOption && c == '{') {
        inCommandName=false;
        inCommand=true;
      }
 else {
        commandName.delete(0,commandName.length());
        inCommandName=false;
      }
    }
    if (inCommand && c == '}') {
      if (commandName.toString().equals("begin")) {
        nestedEnvironments++;
      }
      if (nestedEnvironments > 0 && commandName.toString().equals("end")) {
        nestedEnvironments--;
      }
      commandName.delete(0,commandName.length());
      inCommand=false;
    }
    if (c == '&' && !escape && !(inCommand && commandName.toString().equals("url")) && nestedEnvironments == 0) {
      sb.append("\\&");
    }
 else {
      sb.append(c);
    }
    escape=c == '\\';
  }
  sb.append(valueDelimitersOne);
}
