{
  try {
    while (!Thread.interrupted()) {
      try {
        Socket socket=serverSocket.accept();
        socket.setSoTimeout(ONE_SECOND_TIMEOUT);
        if (Thread.interrupted()) {
          return;
        }
        Protocol protocol=new Protocol(socket);
        try {
          protocol.sendMessage(Protocol.IDENTIFIER);
          String message=protocol.receiveMessage();
          if (message.isEmpty()) {
            continue;
          }
          messageHandler.handleMessage(message);
        }
  finally {
          protocol.close();
        }
      }
 catch (      SocketException ex) {
        return;
      }
catch (      IOException e) {
        e.printStackTrace();
      }
    }
  }
  finally {
    closeServerSocket();
  }
}
