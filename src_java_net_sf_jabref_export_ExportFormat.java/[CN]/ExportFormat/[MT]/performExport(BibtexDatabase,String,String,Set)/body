{
  File outFile=new File(file);
  SaveSession ss=getSaveSession(encoding,outFile);
  final String dir;
  if (customExport)   dir="";
 else   dir=(directory == null ? Globals.LAYOUT_PREFIX : Globals.LAYOUT_PREFIX + directory + "/");
  VerifyingWriter ps=ss.getWriter();
  Layout beginLayout=null;
  Reader reader;
  try {
    reader=FileActions.getReader(dir + lfFileName + ".begin.layout");
    LayoutHelper layoutHelper=new LayoutHelper(reader);
    beginLayout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
    reader.close();
  }
 catch (  IOException ex) {
  }
  if (beginLayout != null) {
    ps.write(beginLayout.doLayout(database));
  }
  List sorted=FileActions.getSortedEntries(database,entries,false);
  reader=FileActions.getReader(dir + lfFileName + ".layout");
  LayoutHelper layoutHelper=new LayoutHelper(reader);
  Layout defLayout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
  reader.close();
  HashMap layouts=new HashMap();
  Layout layout;
  Iterator i=sorted.iterator();
  for (; i.hasNext(); ) {
    BibtexEntry entry=(BibtexEntry)(i.next());
    String type=entry.getType().getName().toLowerCase();
    if (layouts.containsKey(type))     layout=(Layout)layouts.get(type);
 else {
      try {
        reader=FileActions.getReader(dir + lfFileName + "."+ type+ ".layout");
        layoutHelper=new LayoutHelper(reader);
        layout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
        layouts.put(type,layout);
        reader.close();
      }
 catch (      IOException ex) {
        layout=defLayout;
      }
    }
    ps.write(layout.doLayout(entry,database));
  }
  Layout endLayout=null;
  try {
    reader=FileActions.getReader(dir + lfFileName + ".end.layout");
    layoutHelper=new LayoutHelper(reader);
    endLayout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
    reader.close();
  }
 catch (  IOException ex) {
  }
  if (endLayout != null) {
    ps.write(endLayout.doLayout(database));
  }
  try {
    finalizeSaveSession(ss);
  }
 catch (  SaveException e) {
    e.printStackTrace();
  }
}
