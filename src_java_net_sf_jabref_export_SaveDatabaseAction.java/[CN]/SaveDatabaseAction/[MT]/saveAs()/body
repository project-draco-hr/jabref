{
  String chosenFile=null;
  File f=null;
  while (f == null) {
    chosenFile=Globals.getNewFile(frame,new File(Globals.prefs.get("workingDirectory")),".bib",JFileChooser.SAVE_DIALOG,false,null);
    if (chosenFile == null) {
      cancelled=true;
      return;
    }
    f=new File(chosenFile);
    if (f.exists() && (JOptionPane.showConfirmDialog(frame,"'" + f.getName() + "' "+ Globals.lang("exists. Overwrite file?"),Globals.lang("Save database"),JOptionPane.OK_CANCEL_OPTION) != JOptionPane.OK_OPTION)) {
      f=null;
    }
  }
  if (chosenFile != null) {
    File oldFile=panel.metaData().getFile();
    panel.metaData().setFile(f);
    Globals.prefs.put("workingDirectory",f.getParent());
    runCommand();
    if (!success) {
      panel.metaData().setFile(oldFile);
      return;
    }
    try {
      panel.setFileMonitorHandle(Globals.fileUpdateMonitor.addUpdateListener(panel,panel.getFile()));
    }
 catch (    IOException ex) {
      ex.printStackTrace();
    }
    frame.getFileHistory().newFile(panel.metaData().getFile().getPath());
  }
}
