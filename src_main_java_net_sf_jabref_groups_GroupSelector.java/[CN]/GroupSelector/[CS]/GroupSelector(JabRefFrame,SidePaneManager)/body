{
  super(manager,IconTheme.getImage("toggleGroups"),Localization.lang("Groups"));
  this.groupsRoot=new GroupTreeNode(new AllEntriesGroup());
  this.frame=frame;
  hideNonHits=new JRadioButtonMenuItem(Localization.lang("Hide non-hits"),!Globals.prefs.getBoolean(JabRefPreferences.GRAY_OUT_NON_HITS));
  grayOut=new JRadioButtonMenuItem(Localization.lang("Gray out non-hits"),Globals.prefs.getBoolean(JabRefPreferences.GRAY_OUT_NON_HITS));
  ButtonGroup nonHits=new ButtonGroup();
  nonHits.add(hideNonHits);
  nonHits.add(grayOut);
  floatCb.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent event){
      Globals.prefs.putBoolean(JabRefPreferences.GROUP_FLOAT_SELECTIONS,floatCb.isSelected());
    }
  }
);
  andCb.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent event){
      Globals.prefs.putBoolean(JabRefPreferences.GROUP_INTERSECT_SELECTIONS,andCb.isSelected());
    }
  }
);
  invCb.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent event){
      Globals.prefs.putBoolean(JabRefPreferences.GROUP_INVERT_SELECTIONS,invCb.isSelected());
    }
  }
);
  showOverlappingGroups.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent event){
      Globals.prefs.putBoolean(JabRefPreferences.GROUP_SHOW_OVERLAPPING,showOverlappingGroups.isSelected());
      if (!showOverlappingGroups.isSelected()) {
        groupsTree.setHighlight2Cells(null);
      }
    }
  }
);
  select.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent event){
      Globals.prefs.putBoolean(JabRefPreferences.GROUP_SELECT_MATCHES,select.isSelected());
    }
  }
);
  grayOut.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent event){
      Globals.prefs.putBoolean(JabRefPreferences.GRAY_OUT_NON_HITS,grayOut.isSelected());
    }
  }
);
  JRadioButtonMenuItem highlCb=new JRadioButtonMenuItem(Localization.lang("Highlight"),false);
  if (Globals.prefs.getBoolean(JabRefPreferences.GROUP_FLOAT_SELECTIONS)) {
    floatCb.setSelected(true);
    highlCb.setSelected(false);
  }
 else {
    highlCb.setSelected(true);
    floatCb.setSelected(false);
  }
  JRadioButtonMenuItem orCb=new JRadioButtonMenuItem(Localization.lang("Union"),false);
  if (Globals.prefs.getBoolean(JabRefPreferences.GROUP_INTERSECT_SELECTIONS)) {
    andCb.setSelected(true);
    orCb.setSelected(false);
  }
 else {
    orCb.setSelected(true);
    andCb.setSelected(false);
  }
  showNumberOfElements.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent e){
      Globals.prefs.putBoolean(JabRefPreferences.GROUP_SHOW_NUMBER_OF_ELEMENTS,showNumberOfElements.isSelected());
      if (groupsTree != null) {
        groupsTree.invalidate();
        groupsTree.validate();
        groupsTree.repaint();
      }
    }
  }
);
  autoAssignGroup.addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent event){
      Globals.prefs.putBoolean(JabRefPreferences.AUTO_ASSIGN_GROUP,autoAssignGroup.isSelected());
    }
  }
);
  invCb.setSelected(Globals.prefs.getBoolean(JabRefPreferences.GROUP_INVERT_SELECTIONS));
  showOverlappingGroups.setSelected(Globals.prefs.getBoolean(JabRefPreferences.GROUP_SHOW_OVERLAPPING));
  select.setSelected(Globals.prefs.getBoolean(JabRefPreferences.GROUP_SELECT_MATCHES));
  editModeIndicator=Globals.prefs.getBoolean(JabRefPreferences.EDIT_GROUP_MEMBERSHIP_MODE);
  editModeCb.setSelected(editModeIndicator);
  showNumberOfElements.setSelected(Globals.prefs.getBoolean(JabRefPreferences.GROUP_SHOW_NUMBER_OF_ELEMENTS));
  autoAssignGroup.setSelected(Globals.prefs.getBoolean(JabRefPreferences.AUTO_ASSIGN_GROUP));
  openset.setMargin(new Insets(0,0,0,0));
  settings.add(andCb);
  settings.add(orCb);
  settings.addSeparator();
  settings.add(invCb);
  settings.addSeparator();
  settings.add(select);
  settings.addSeparator();
  settings.add(editModeCb);
  settings.addSeparator();
  settings.add(grayOut);
  settings.add(hideNonHits);
  settings.addSeparator();
  settings.add(showOverlappingGroups);
  settings.addSeparator();
  settings.add(showNumberOfElements);
  settings.add(autoAssignGroup);
  openset.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      if (settings.isVisible()) {
      }
 else {
        JButton src=(JButton)e.getSource();
        showNumberOfElements.setSelected(Globals.prefs.getBoolean(JabRefPreferences.GROUP_SHOW_NUMBER_OF_ELEMENTS));
        autoAssignGroup.setSelected(Globals.prefs.getBoolean(JabRefPreferences.AUTO_ASSIGN_GROUP));
        settings.show(src,0,openset.getHeight());
      }
    }
  }
);
  JButton expand=new JButton(IconTheme.getImage("down"));
  expand.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      int i=Globals.prefs.getInt(JabRefPreferences.GROUPS_VISIBLE_ROWS) + 1;
      groupsTree.setVisibleRowCount(i);
      groupsTree.revalidate();
      groupsTree.repaint();
      GroupSelector.this.revalidate();
      GroupSelector.this.repaint();
      Globals.prefs.putInt(JabRefPreferences.GROUPS_VISIBLE_ROWS,i);
      LOGGER.info("Height: " + GroupSelector.this.getHeight() + "; Preferred height: "+ GroupSelector.this.getPreferredSize().getHeight());
    }
  }
);
  JButton reduce=new JButton(IconTheme.getImage("up"));
  reduce.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      int i=Globals.prefs.getInt(JabRefPreferences.GROUPS_VISIBLE_ROWS) - 1;
      if (i < 1) {
        i=1;
      }
      groupsTree.setVisibleRowCount(i);
      groupsTree.revalidate();
      groupsTree.repaint();
      GroupSelector.this.revalidate();
      GroupSelector.this.repaint();
      Globals.prefs.putInt(JabRefPreferences.GROUPS_VISIBLE_ROWS,i);
    }
  }
);
  editModeCb.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      editModeIndicator=editModeCb.getState();
      updateBorder(editModeIndicator);
      Globals.prefs.putBoolean(JabRefPreferences.EDIT_GROUP_MEMBERSHIP_MODE,editModeIndicator);
    }
  }
);
  int butSize=newButton.getIcon().getIconHeight() + 5;
  Dimension butDim=new Dimension(butSize,butSize);
  newButton.setPreferredSize(butDim);
  newButton.setMinimumSize(butDim);
  refresh.setPreferredSize(butDim);
  refresh.setMinimumSize(butDim);
  JButton helpButton=new JButton(IconTheme.getImage("help"));
  helpButton.setPreferredSize(butDim);
  helpButton.setMinimumSize(butDim);
  autoGroup.setPreferredSize(butDim);
  autoGroup.setMinimumSize(butDim);
  openset.setPreferredSize(butDim);
  openset.setMinimumSize(butDim);
  expand.setPreferredSize(butDim);
  expand.setMinimumSize(butDim);
  reduce.setPreferredSize(butDim);
  reduce.setMinimumSize(butDim);
  Insets butIns=new Insets(0,0,0,0);
  helpButton.setMargin(butIns);
  reduce.setMargin(butIns);
  expand.setMargin(butIns);
  openset.setMargin(butIns);
  newButton.addActionListener(this);
  refresh.addActionListener(this);
  andCb.addActionListener(this);
  orCb.addActionListener(this);
  invCb.addActionListener(this);
  showOverlappingGroups.addActionListener(this);
  autoGroup.addActionListener(this);
  floatCb.addActionListener(this);
  highlCb.addActionListener(this);
  select.addActionListener(this);
  hideNonHits.addActionListener(this);
  grayOut.addActionListener(this);
  newButton.setToolTipText(Localization.lang("New group"));
  refresh.setToolTipText(Localization.lang("Refresh view"));
  andCb.setToolTipText(Localization.lang("Display only entries belonging to all selected" + " groups."));
  orCb.setToolTipText(Localization.lang("Display all entries belonging to one or more " + "of the selected groups."));
  autoGroup.setToolTipText(Localization.lang("Automatically create groups for database."));
  invCb.setToolTipText(Localization.lang("Show entries *not* in group selection"));
  showOverlappingGroups.setToolTipText("Highlight groups that contain entries contained in any currently selected group");
  floatCb.setToolTipText(Localization.lang("Move entries in group selection to the top"));
  highlCb.setToolTipText(Localization.lang("Gray out entries not in group selection"));
  select.setToolTipText(Localization.lang("Select entries in group selection"));
  expand.setToolTipText(Localization.lang("Show one more row"));
  reduce.setToolTipText(Localization.lang("Show one less rows"));
  editModeCb.setToolTipText(Localization.lang("Click group to toggle membership of selected entries"));
  ButtonGroup bgr=new ButtonGroup();
  bgr.add(andCb);
  bgr.add(orCb);
  ButtonGroup visMode=new ButtonGroup();
  visMode.add(floatCb);
  visMode.add(highlCb);
  JPanel main=new JPanel();
  GridBagLayout gbl=new GridBagLayout();
  main.setLayout(gbl);
  GridBagConstraints con=new GridBagConstraints();
  con.fill=GridBagConstraints.BOTH;
  con.weightx=1;
  con.gridwidth=1;
  con.gridx=0;
  con.gridy=0;
  gbl.setConstraints(newButton,con);
  main.add(newButton);
  con.gridx=1;
  gbl.setConstraints(refresh,con);
  main.add(refresh);
  con.gridx=2;
  gbl.setConstraints(autoGroup,con);
  main.add(autoGroup);
  con.gridx=3;
  con.gridwidth=GridBagConstraints.REMAINDER;
  HelpAction helpAction=new HelpAction(frame.helpDiag,GUIGlobals.groupsHelp,Localization.lang("Help on groups"));
  helpButton.addActionListener(helpAction);
  helpButton.setToolTipText(Localization.lang("Help on groups"));
  gbl.setConstraints(helpButton,con);
  main.add(helpButton);
  groupsTree=new GroupsTree(this);
  groupsTree.addTreeSelectionListener(this);
  groupsTree.setModel(groupsTreeModel=new DefaultTreeModel(groupsRoot));
  JScrollPane sp=new JScrollPane(groupsTree,JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED,JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
  revalidateGroups();
  con.gridwidth=GridBagConstraints.REMAINDER;
  con.weighty=1;
  con.gridx=0;
  con.gridwidth=4;
  con.gridy=1;
  gbl.setConstraints(sp,con);
  main.add(sp);
  JPanel pan=new JPanel();
  GridBagLayout gb=new GridBagLayout();
  con.weighty=0;
  gbl.setConstraints(pan,con);
  pan.setLayout(gb);
  con.insets=new Insets(0,0,0,0);
  con.gridx=0;
  con.gridy=0;
  con.weightx=1;
  con.gridwidth=4;
  con.fill=GridBagConstraints.HORIZONTAL;
  gb.setConstraints(openset,con);
  pan.add(openset);
  con.gridwidth=1;
  con.gridx=4;
  con.gridy=0;
  gb.setConstraints(expand,con);
  pan.add(expand);
  con.gridx=5;
  gb.setConstraints(reduce,con);
  pan.add(reduce);
  con.gridwidth=6;
  con.gridy=1;
  con.gridx=0;
  con.fill=GridBagConstraints.HORIZONTAL;
  con.gridy=2;
  con.gridx=0;
  con.gridwidth=4;
  gbl.setConstraints(pan,con);
  main.add(pan);
  main.setBorder(BorderFactory.createEmptyBorder(1,1,1,1));
  add(main,BorderLayout.CENTER);
  updateBorder(editModeIndicator);
  definePopup();
  NodeAction moveNodeUpAction=new MoveNodeUpAction();
  moveNodeUpAction.putValue(Action.ACCELERATOR_KEY,KeyStroke.getKeyStroke(KeyEvent.VK_UP,KeyEvent.CTRL_MASK));
  NodeAction moveNodeDownAction=new MoveNodeDownAction();
  moveNodeDownAction.putValue(Action.ACCELERATOR_KEY,KeyStroke.getKeyStroke(KeyEvent.VK_DOWN,KeyEvent.CTRL_MASK));
  NodeAction moveNodeLeftAction=new MoveNodeLeftAction();
  moveNodeLeftAction.putValue(Action.ACCELERATOR_KEY,KeyStroke.getKeyStroke(KeyEvent.VK_LEFT,KeyEvent.CTRL_MASK));
  NodeAction moveNodeRightAction=new MoveNodeRightAction();
  moveNodeRightAction.putValue(Action.ACCELERATOR_KEY,KeyStroke.getKeyStroke(KeyEvent.VK_RIGHT,KeyEvent.CTRL_MASK));
}
