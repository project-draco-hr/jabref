{
  if (metaData == null) {
    List<BibEntry> result=new LinkedList<>();
    result.addAll(database.getEntries());
    return result;
  }
  boolean inOriginalOrder;
  if (isSaveOperation) {
    List<String> storedSaveOrderConfig=metaData.getData(DatabasePropertiesDialog.SAVE_ORDER_CONFIG);
    if (storedSaveOrderConfig == null) {
      inOriginalOrder=true;
    }
 else {
      SaveOrderConfig saveOrderConfig=new SaveOrderConfig(storedSaveOrderConfig);
      inOriginalOrder=saveOrderConfig.saveInOriginalOrder;
    }
  }
 else {
    inOriginalOrder=Globals.prefs.getBoolean(JabRefPreferences.EXPORT_IN_ORIGINAL_ORDER);
  }
  List<Comparator<BibEntry>> comparators;
  if (inOriginalOrder) {
    comparators=new ArrayList<>();
    comparators.add(new CrossRefEntryComparator());
    comparators.add(new IdComparator());
  }
 else {
    comparators=FileActions.getSaveComparators(isSaveOperation,metaData);
  }
  FieldComparatorStack<BibEntry> comparatorStack=new FieldComparatorStack<>(comparators);
  List<BibEntry> sorter=new ArrayList<>();
  if (keySet == null) {
    keySet=database.getKeySet();
  }
  for (  String id : keySet) {
    sorter.add(database.getEntryById(id));
  }
  Collections.sort(sorter,comparatorStack);
  return sorter;
}
