{
  Object o=be.getField(BibtexFields.MARKED);
  if (o != null) {
    String s=o.toString();
    if (s.equals("0")) {
      if (!onlyMaxLevel) {
        unmarkOldStyle(be,database,ce);
      }
      return;
    }
    String newValue=null;
    int index=s.indexOf(Globals.prefs.WRAPPED_USERNAME);
    if (index >= 0) {
      if (!onlyMaxLevel)       newValue=s.substring(0,index) + s.substring(index + Globals.prefs.WRAPPED_USERNAME.length());
 else       return;
    }
 else {
      Matcher m=markNumberPattern.matcher(s);
      if (m.find()) {
        try {
          int prevMarkLevel=Integer.parseInt(m.group(1));
          if (!onlyMaxLevel || (prevMarkLevel == MARK_COLOR_LEVELS)) {
            if (prevMarkLevel > 1)             newValue=s.substring(0,m.start(1)) + s.substring(m.end(1));
 else {
              String toRemove=Globals.prefs.WRAPPED_USERNAME.substring(0,Globals.prefs.WRAPPED_USERNAME.length() - 1) + ":1]";
              index=s.indexOf(toRemove);
              if (index >= 0) {
                newValue=s.substring(0,index) + s.substring(index + toRemove.length());
              }
            }
          }
 else           return;
        }
 catch (        NumberFormatException ex) {
        }
      }
    }
    ce.addEdit(new UndoableFieldChange(be,BibtexFields.MARKED,be.getField(BibtexFields.MARKED),newValue));
    be.setField(BibtexFields.MARKED,newValue);
  }
}
