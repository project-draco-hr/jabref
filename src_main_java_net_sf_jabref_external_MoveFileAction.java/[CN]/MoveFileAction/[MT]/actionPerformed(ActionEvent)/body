{
  int selected=editor.getSelectedRow();
  if (selected == -1)   return;
  FileListEntry flEntry=editor.getTableModel().getEntry(selected);
  String ln=flEntry.getLink();
  boolean httpLink=ln.toLowerCase().startsWith("http");
  if (httpLink) {
  }
  String[] dirs=frame.basePanel().metaData().getFileDirectory(GUIGlobals.FILE_FIELD);
  int found=-1;
  for (int i=0; i < dirs.length; i++)   if (new File(dirs[i]).exists()) {
    found=i;
    break;
  }
  if (found < 0) {
    JOptionPane.showMessageDialog(frame,Globals.lang("File_directory_is_not_set_or_does_not_exist!"),Globals.lang("Move/Rename file"),JOptionPane.ERROR_MESSAGE);
    return;
  }
  File file=new File(ln);
  if (!file.isAbsolute()) {
    file=Util.expandFilename(ln,dirs);
  }
  if ((file != null) && file.exists()) {
    String extension=null;
    if (flEntry.getType() != null)     extension="." + flEntry.getType().getExtension();
    File newFile=null;
    boolean repeat=true;
    while (repeat) {
      repeat=false;
      String chosenFile;
      if (toFileDir) {
        String suggName=Util.getLinkedFileName(eEditor.getDatabase(),eEditor.getEntry()).concat(".").concat(flEntry.getType().extension);
        CheckBoxMessage cbm=new CheckBoxMessage(Globals.lang("Move file to file directory?"),Globals.lang("Rename to '%0'",suggName),Globals.prefs.getBoolean("renameOnMoveFileToFileDir"));
        int answer;
        if (!suggName.equals(file.getName()))         answer=JOptionPane.showConfirmDialog(frame,cbm,Globals.lang("Move/Rename file"),JOptionPane.YES_NO_OPTION);
 else         answer=JOptionPane.showConfirmDialog(frame,Globals.lang("Move file to file directory?"),Globals.lang("Move/Rename file"),JOptionPane.YES_NO_OPTION);
        if (answer != JOptionPane.YES_OPTION)         return;
        Globals.prefs.putBoolean("renameOnMoveFileToFileDir",cbm.isSelected());
        StringBuilder sb=new StringBuilder(dirs[found]);
        if (!dirs[found].endsWith(File.separator))         sb.append(File.separator);
        if (cbm.isSelected()) {
          sb.append(suggName);
        }
 else {
          sb.append(file.getName());
        }
        chosenFile=sb.toString();
      }
 else {
        chosenFile=FileDialogs.getNewFile(frame,file,extension,JFileChooser.SAVE_DIALOG,false);
      }
      if (chosenFile == null) {
        return;
      }
      newFile=new File(chosenFile);
      if (newFile.exists() && (JOptionPane.showConfirmDialog(frame,"'" + newFile.getName() + "' "+ Globals.lang("exists. Overwrite file?"),Globals.lang("Move/Rename file"),JOptionPane.OK_CANCEL_OPTION) != JOptionPane.OK_OPTION)) {
        if (!toFileDir)         repeat=true;
 else         return;
      }
    }
    if (!newFile.equals(file)) {
      try {
        boolean success=file.renameTo(newFile);
        if (!success) {
          success=Util.copyFile(file,newFile,true);
        }
        if (success) {
          file.delete();
          String canPath=(new File(dirs[found])).getCanonicalPath();
          if (newFile.getCanonicalPath().startsWith(canPath)) {
            if ((newFile.getCanonicalPath().length() > canPath.length()) && (newFile.getCanonicalPath().charAt(canPath.length()) == File.separatorChar))             flEntry.setLink(newFile.getCanonicalPath().substring(1 + canPath.length()));
 else             flEntry.setLink(newFile.getCanonicalPath().substring(canPath.length()));
          }
 else           flEntry.setLink(newFile.getCanonicalPath());
          eEditor.updateField(editor);
          frame.output(Globals.lang("File moved"));
        }
 else {
          JOptionPane.showMessageDialog(frame,Globals.lang("Move file failed"),Globals.lang("Move/Rename file"),JOptionPane.ERROR_MESSAGE);
        }
      }
 catch (      SecurityException ex) {
        ex.printStackTrace();
        JOptionPane.showMessageDialog(frame,Globals.lang("Could not move file") + ": " + ex.getMessage(),Globals.lang("Move/Rename file"),JOptionPane.ERROR_MESSAGE);
      }
catch (      IOException ex) {
        ex.printStackTrace();
        JOptionPane.showMessageDialog(frame,Globals.lang("Could not move file") + ": " + ex.getMessage(),Globals.lang("Move/Rename file"),JOptionPane.ERROR_MESSAGE);
      }
    }
  }
 else {
    JOptionPane.showMessageDialog(frame,Globals.lang("Could not find file '%0'.",flEntry.getLink()),Globals.lang("File not found"),JOptionPane.ERROR_MESSAGE);
  }
}
