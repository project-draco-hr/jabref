{
  if (selected.length != 2) {
    JOptionPane.showMessageDialog(frame,Globals.lang("Must choose exactly two entries to merge."),Globals.lang("Merge entries"),JOptionPane.INFORMATION_MESSAGE);
    this.dispose();
    return;
  }
  one=selected[0];
  two=selected[1];
  ce=new NamedCompound(Globals.lang("Merge entries"));
  joint=new TreeSet<String>(one.getAllFields());
  joint.addAll(two.getAllFields());
  Set<String> toberemoved=new TreeSet<String>();
  for (  String field : joint) {
    if (field.startsWith("__")) {
      toberemoved.add(field);
    }
  }
  for (  String field : toberemoved) {
    joint.remove(field);
  }
  rb=new JRadioButton[3][joint.size() + 1];
  rbg=new ButtonGroup[joint.size() + 1];
  identical=new Boolean[joint.size() + 1];
  jointStrings=new String[joint.size()];
  String colSpec="left:pref, 5px, fill:4cm:grow, 5px, right:pref, 3px, center:pref, 3px, left:pref, 5px, fill:4cm:grow";
  StringBuilder rowBuilder=new StringBuilder("pref, 10px, pref, ");
  for (int i=0; i < joint.size(); i++) {
    rowBuilder.append("pref, ");
  }
  rowBuilder.append("10px, top:4cm:grow, 10px, pref");
  FormLayout layout=new FormLayout(colSpec,rowBuilder.toString());
  this.setLayout(layout);
  for (int i=0; i < 6; i++) {
    JLabel label=new JLabel(columnHeadings[i]);
    Font font=label.getFont();
    label.setFont(font.deriveFont(font.getStyle() | Font.BOLD));
    this.add(label,cc.xy(1 + i * 2,1));
  }
  this.add(new JSeparator(),cc.xyw(1,2,11));
  BibtexEntryType type1=one.getType();
  BibtexEntryType type2=two.getType();
  mergedEntry.setType(type1);
  JLabel label=new JLabel(Globals.lang("Entry type"));
  Font font=label.getFont();
  label.setFont(font.deriveFont(font.getStyle() | Font.BOLD));
  this.add(label,cc.xy(1,3));
  JTextArea type1ta=new JTextArea(type1.getName());
  type1ta.setEditable(false);
  this.add(type1ta,cc.xy(3,3));
  if (type1.compareTo(type2) != 0) {
    identical[0]=false;
    rbg[0]=new ButtonGroup();
    for (int k=0; k < 3; k+=2) {
      rb[k][0]=new JRadioButton();
      rbg[0].add(rb[k][0]);
      this.add(rb[k][0],cc.xy(5 + k * 2,3));
      rb[k][0].addChangeListener(new ChangeListener(){
        public void stateChanged(        ChangeEvent e){
          updateAll();
        }
      }
);
    }
    rb[0][0].setSelected(true);
  }
 else {
    identical[0]=true;
  }
  JTextArea type2ta=new JTextArea(type2.getName());
  type2ta.setEditable(false);
  this.add(type2ta,cc.xy(11,3));
  int row=4;
  for (  String field : joint) {
    jointStrings[row - 4]=field;
    label=new JLabel(Util.toUpperFirstLetter(field));
    font=label.getFont();
    label.setFont(font.deriveFont(font.getStyle() | Font.BOLD));
    this.add(label,cc.xy(1,row));
    String string1=one.getField(field);
    String string2=two.getField(field);
    identical[row - 3]=false;
    if ((string1 != null) && (string2 != null)) {
      if (string1.equals(string2)) {
        identical[row - 3]=true;
      }
    }
    if (field.equals("abstract")) {
      JTextArea tf=new JTextArea();
      tf.setLineWrap(true);
      tf.setEditable(false);
      JScrollPane jsptf=new JScrollPane(tf);
      layout.setRowSpec(row,RowSpec.decode("center:2cm:grow"));
      this.add(jsptf,cc.xy(3,row,"f, f"));
      tf.setText(string1);
      tf.setCaretPosition(0);
    }
 else {
      JTextArea tf=new JTextArea(string1);
      this.add(tf,cc.xy(3,row));
      tf.setCaretPosition(0);
      tf.setEditable(false);
    }
    if (!identical[row - 3]) {
      rbg[row - 3]=new ButtonGroup();
      for (int k=0; k < 3; k++) {
        rb[k][row - 3]=new JRadioButton();
        rbg[row - 3].add(rb[k][row - 3]);
        this.add(rb[k][row - 3],cc.xy(5 + k * 2,row));
        rb[k][row - 3].addChangeListener(new ChangeListener(){
          public void stateChanged(          ChangeEvent e){
            updateAll();
          }
        }
);
      }
      if (string1 != null) {
        mergedEntry.setField(field,string1);
        rb[0][row - 3].setSelected(true);
      }
 else {
        mergedEntry.setField(field,string2);
        rb[2][row - 3].setSelected(true);
      }
    }
 else {
      mergedEntry.setField(field,string1);
    }
    if (field.equals("abstract")) {
      JTextArea tf=new JTextArea();
      tf.setLineWrap(true);
      tf.setEditable(false);
      JScrollPane jsptf=new JScrollPane(tf);
      this.add(jsptf,cc.xy(11,row,"f, f"));
      tf.setText(string2);
      tf.setCaretPosition(0);
    }
 else {
      JTextArea tf=new JTextArea(string2);
      this.add(tf,cc.xy(11,row));
      tf.setCaretPosition(0);
      tf.setEditable(false);
    }
    row++;
  }
  this.add(new JSeparator(),cc.xyw(1,row,11));
  row++;
  label=new JLabel(Globals.lang("Merged entry"));
  font=label.getFont();
  label.setFont(font.deriveFont(font.getStyle() | Font.BOLD));
  this.add(label,cc.xy(1,row));
  String layoutString=Globals.prefs.get("preview0");
  pp=new PreviewPanel(null,mergedEntry,null,new MetaData(),layoutString);
  this.add(pp,cc.xyw(3,row,3));
  jta=new JTextArea();
  jta.setLineWrap(true);
  JScrollPane jspta=new JScrollPane(jta);
  this.add(jspta,cc.xyw(9,row,3));
  jta.setEditable(false);
  StringWriter sw=new StringWriter();
  try {
    mergedEntry.write(sw,new LatexFieldFormatter(),false);
  }
 catch (  IOException ex) {
    System.err.println(Globals.lang("Error in entry: " + ex.getMessage()));
  }
  jta.setText(sw.getBuffer().toString());
  jta.setCaretPosition(0);
  row++;
  this.add(new JSeparator(),cc.xyw(1,row,11));
  row++;
  ButtonBarBuilder bb=new ButtonBarBuilder();
  bb.addGlue();
  JButton cancel=new JButton(Globals.lang("Cancel"));
  cancel.setActionCommand("cancel");
  cancel.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      buttonPressed(e.getActionCommand());
    }
  }
);
  JButton newentry=new JButton(Globals.lang("Add new entry and keep both old entries"));
  newentry.setActionCommand("newentry");
  newentry.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      buttonPressed(e.getActionCommand());
    }
  }
);
  JButton replaceentries=new JButton(Globals.lang("Replace old entries with new entry"));
  replaceentries.setActionCommand("replace");
  replaceentries.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      buttonPressed(e.getActionCommand());
    }
  }
);
  bb.addButton(new JButton[]{replaceentries,newentry,cancel});
  this.add(bb.getPanel(),cc.xyw(1,row,11));
  layout.appendRow(RowSpec.decode("10px"));
  layout.appendColumn(ColumnSpec.decode("10px"));
  layout.insertRow(1,RowSpec.decode("10px"));
  layout.insertColumn(1,ColumnSpec.decode("10px"));
  pack();
  if (getHeight() > DIM.height) {
    setSize(new Dimension(getWidth(),DIM.height));
  }
  if (getWidth() > DIM.width) {
    setSize(new Dimension(DIM.width,getHeight()));
  }
  doneBuilding=true;
  setVisible(true);
}
