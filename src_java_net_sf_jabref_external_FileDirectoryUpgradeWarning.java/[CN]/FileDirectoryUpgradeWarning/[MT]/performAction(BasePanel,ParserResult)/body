{
  boolean offerSetFileDir=!(panel.metaData().getData(GUIGlobals.FILE_FIELD + "Directory") == null) && (panel.metaData().getData(Globals.prefs.get("userFileDir")) == null);
  if (!offerSetFileDir)   return;
  JCheckBox setFileDir=new JCheckBox(Globals.lang("Set user specific file directory") + ":",offerSetFileDir);
  JTextField fileDir=new JTextField(30);
  JCheckBox retainOldFileDir=new JCheckBox(Globals.lang("Retain legacy file directory setting (for older versions of JabRef)"),false);
  JCheckBox doNotShowDialog=new JCheckBox(Globals.lang("Do not show these options in the future"),false);
  StringBuilder sb=new StringBuilder("<html>");
  sb.append(Globals.lang("This database was written using an older version of JabRef."));
  sb.append("<br>");
  sb.append(Globals.lang("The current version features a new way of storing the file directory setting of<br>" + "a database. This enables multiple users of the same database file to keep their<br>" + "own personal setting for the path to the file directory.<br>"+ "To take advantage of this, your file directory setting must be changed into the<br>"+ "new format."));
  sb.append("<p>");
  sb.append(Globals.lang("Do you want JabRef to do the following operations?"));
  sb.append("</html>");
  JPanel message=new JPanel();
  DefaultFormBuilder b=new DefaultFormBuilder(new FormLayout("left:pref",""),message);
  b.append(new JLabel(sb.toString()));
  b.nextLine();
  if (offerSetFileDir) {
    if (panel.metaData().getData(GUIGlobals.FILE_FIELD + "Directory") != null)     fileDir.setText(panel.metaData().getData(GUIGlobals.FILE_FIELD + "Directory").firstElement());
    JPanel pan=new JPanel();
    pan.add(setFileDir);
    pan.add(fileDir);
    JButton browse=new JButton(Globals.lang("Browse"));
    browse.addActionListener(new BrowseAction(null,fileDir,true));
    pan.add(browse);
    b.append(pan);
    b.nextLine();
    JPanel pan2=new JPanel();
    pan2.add(retainOldFileDir);
    b.append(pan2);
    b.nextLine();
  }
  b.append("");
  b.nextLine();
  b.append(doNotShowDialog);
  int answer=JOptionPane.showConfirmDialog(panel.frame(),message,Globals.lang("Upgrade file") + " - " + pr.getFile().getName(),JOptionPane.YES_NO_OPTION);
  if (doNotShowDialog.isSelected())   Globals.prefs.putBoolean("showFileDirUpgradeWarning",false);
  if (answer == JOptionPane.YES_OPTION)   makeChanges(panel,pr,setFileDir.isSelected() ? fileDir.getText() : null,retainOldFileDir.isSelected());
}
