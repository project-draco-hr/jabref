{
  if (cancelled) {
    return;
  }
  int choice=showCleanUpDialog();
  if (choice != JOptionPane.OK_OPTION) {
    cancelled=true;
    return;
  }
  storeSettings();
  boolean choiceCleanUpSuperscripts=cleanUpSuperscrips.isSelected();
  boolean choiceCleanUpDOI=cleanUpDOI.isSelected();
  boolean choiceCleanUpMonth=cleanUpMonth.isSelected();
  boolean choiceCleanUpPageNumbers=cleanUpPageNumbers.isSelected();
  boolean choiceCleanUpUpgradeExternalLinks=cleanUpUpgradeExternalLinks.isSelected();
  boolean choiceMakePathsRelative=cleanUpMakePathsRelative.isSelected();
  boolean choiceRenamePDF=cleanUpRenamePDF.isSelected();
  boolean choiceConvertHTML=cleanUpHTML.isSelected();
  boolean choiceConvertCase=cleanUpCase.isSelected();
  boolean choiceConvertLaTeX=cleanUpLaTeX.isSelected();
  boolean choiceConvertUnits=cleanUpUnits.isSelected();
  boolean choiceConvertUnicode=cleanUpUnicode.isSelected();
  boolean choiceConvertToBiblatex=cleanUpBiblatex.isSelected();
  if (choiceRenamePDF && Globals.prefs.getBoolean(CleanUpAction.AKS_AUTO_NAMING_PDFS_AGAIN)) {
    CheckBoxMessage cbm=new CheckBoxMessage(Localization.lang("Auto-generating PDF-Names does not support undo. Continue?"),Localization.lang("Disable this confirmation dialog"),false);
    int answer=JOptionPane.showConfirmDialog(frame,cbm,Localization.lang("Autogenerate PDF Names"),JOptionPane.YES_NO_OPTION);
    if (cbm.isSelected()) {
      Globals.prefs.putBoolean(CleanUpAction.AKS_AUTO_NAMING_PDFS_AGAIN,false);
    }
    if (answer == JOptionPane.NO_OPTION) {
      cancelled=true;
      return;
    }
  }
  if (choiceCleanUpUpgradeExternalLinks) {
    NamedCompound ce=Util.upgradePdfPsToFile(Arrays.asList(panel.getSelectedEntries()),new String[]{"pdf","ps"});
    if (ce.hasEdits()) {
      panel.undoManager.addEdit(ce);
      panel.markBaseChanged();
      panel.updateEntryEditorIfShowing();
      panel.output(Localization.lang("Upgraded links."));
    }
  }
  for (  BibtexEntry entry : panel.getSelectedEntries()) {
    NamedCompound ce=new NamedCompound(Localization.lang("Cleanup entry"));
    if (choiceCleanUpSuperscripts) {
      doCleanUpSuperscripts(entry,ce);
    }
    if (choiceCleanUpDOI) {
      doCleanUpDOI(entry,ce);
    }
    if (choiceCleanUpMonth) {
      doCleanUpMonth(entry,ce);
    }
    if (choiceCleanUpPageNumbers) {
      doCleanUpPageNumbers(entry,ce);
    }
    fixWrongFileEntries(entry,ce);
    if (choiceMakePathsRelative) {
      doMakePathsRelative(entry,ce);
    }
    if (choiceRenamePDF) {
      doRenamePDFs(entry,ce);
    }
    if (choiceConvertHTML) {
      doConvertHTML(entry,ce);
    }
    if (choiceConvertUnits) {
      doConvertUnits(entry,ce);
    }
    if (choiceConvertCase) {
      doConvertCase(entry,ce);
    }
    if (choiceConvertLaTeX) {
      doConvertLaTeX(entry,ce);
    }
    if (choiceConvertUnicode) {
      doConvertUnicode(entry,ce);
    }
    if (choiceConvertToBiblatex) {
      doConvertToBiblatex(entry,ce);
    }
    ce.end();
    if (ce.hasEdits()) {
      modifiedEntriesCount++;
      panel.undoManager.addEdit(ce);
    }
  }
}
