{
  if (Globals.prefs.getBoolean(JabRefPreferences.GENERATE_KEYS_BEFORE_SAVING)) {
    NamedCompound ce=new NamedCompound(Localization.lang("Autogenerate BibTeX keys"));
    boolean any=false;
    for (    BibEntry bes : database.getEntries()) {
      Optional<String> oldKey=bes.getCiteKeyOptional();
      if (!(oldKey.isPresent()) || oldKey.get().isEmpty()) {
        BibtexKeyPatternUtil.makeLabel(bibDatabaseContext.getMetaData(),database,bes,BibtexKeyPatternPreferences.fromPreferences(Globals.prefs));
        ce.addEdit(new UndoableKeyChange(database,bes,null,bes.getCiteKeyOptional().get()));
        any=true;
      }
    }
    if (any) {
      ce.end();
      getUndoManager().addEdit(ce);
    }
  }
}
