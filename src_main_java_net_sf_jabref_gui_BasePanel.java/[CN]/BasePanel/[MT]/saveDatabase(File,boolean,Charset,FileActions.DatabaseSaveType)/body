{
  SaveSession session;
  frame.block();
  final String SAVE_DATABASE=Localization.lang("Save database");
  try {
    if (selectedOnly) {
      session=FileActions.savePartOfDatabase(database,metaData,file,Globals.prefs,mainTable.getSelectedEntries(),enc,saveType);
    }
 else {
      session=FileActions.saveDatabase(database,metaData,file,Globals.prefs,false,false,enc,false);
    }
  }
 catch (  UnsupportedCharsetException ex2) {
    JOptionPane.showMessageDialog(frame,Localization.lang("Could not save file.") + ' ' + Localization.lang("Character encoding '%0' is not supported.",enc.displayName()),SAVE_DATABASE,JOptionPane.ERROR_MESSAGE);
    throw new SaveException("rt");
  }
catch (  SaveException ex) {
    if (ex.specificEntry()) {
      final int row=mainTable.findEntry(ex.getEntry());
      final int topShow=Math.max(0,row - 3);
      mainTable.setRowSelectionInterval(row,row);
      mainTable.scrollTo(topShow);
      showEntry(ex.getEntry());
    }
 else {
      LOGGER.warn("Could not save",ex);
    }
    JOptionPane.showMessageDialog(frame,Localization.lang("Could not save file.") + "\n" + ex.getMessage(),SAVE_DATABASE,JOptionPane.ERROR_MESSAGE);
    throw new SaveException("rt");
  }
 finally {
    frame.unblock();
  }
  boolean commit=true;
  if (!session.getWriter().couldEncodeAll()) {
    FormBuilder builder=FormBuilder.create().layout(new FormLayout("left:pref, 4dlu, fill:pref","pref, 4dlu, pref"));
    JTextArea ta=new JTextArea(session.getWriter().getProblemCharacters());
    ta.setEditable(false);
    builder.add(Localization.lang("The chosen encoding '%0' could not encode the following characters:",session.getEncoding().displayName())).xy(1,1);
    builder.add(ta).xy(3,1);
    builder.add(Localization.lang("What do you want to do?")).xy(1,3);
    String tryDiff=Localization.lang("Try different encoding");
    int answer=JOptionPane.showOptionDialog(frame,builder.getPanel(),SAVE_DATABASE,JOptionPane.YES_NO_CANCEL_OPTION,JOptionPane.WARNING_MESSAGE,null,new String[]{Localization.lang("Save"),tryDiff,Localization.lang("Cancel")},tryDiff);
    if (answer == JOptionPane.NO_OPTION) {
      Object choice=JOptionPane.showInputDialog(frame,Localization.lang("Select encoding"),SAVE_DATABASE,JOptionPane.QUESTION_MESSAGE,null,Encodings.ENCODINGS_DISPLAYNAMES,enc);
      if (choice == null) {
        commit=false;
      }
 else {
        Charset newEncoding=Charset.forName((String)choice);
        return saveDatabase(file,selectedOnly,newEncoding,saveType);
      }
    }
 else     if (answer == JOptionPane.CANCEL_OPTION) {
      commit=false;
    }
  }
  if (commit) {
    session.commit();
    this.encoding=enc;
  }
 else {
    session.cancel();
  }
  return commit;
}
