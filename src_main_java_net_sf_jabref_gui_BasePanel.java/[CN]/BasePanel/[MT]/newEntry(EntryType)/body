{
  if (type == null) {
    final EntryTypeDialog etd=new EntryTypeDialog(frame);
    etd.setLocationRelativeTo(frame);
    etd.setVisible(true);
    type=etd.getChoice();
  }
  if (type != null) {
    String id=IdGenerator.next();
    final BibEntry be=new BibEntry(id,type.getName());
    try {
      database.insertEntry(be);
      List<BibEntry> list=new ArrayList<>();
      list.add(be);
      UpdateField.setAutomaticFields(list,true,true);
      undoManager.addEdit(new UndoableInsertEntry(database,be,BasePanel.this));
      output(Localization.lang("Added new '%0' entry.",type.getName().toLowerCase()));
      if (mode != BasePanelMode.SHOWING_EDITOR) {
        mode=BasePanelMode.WILL_SHOW_EDITOR;
      }
      int row=mainTable.findEntry(be);
      if (row >= 0) {
        highlightEntry(be);
      }
 else {
        showEntry(be);
      }
      markBaseChanged();
      new FocusRequester(getEntryEditor(be));
      return be;
    }
 catch (    KeyCollisionException ex) {
      LOGGER.info(ex.getMessage(),ex);
    }
  }
  return null;
}
