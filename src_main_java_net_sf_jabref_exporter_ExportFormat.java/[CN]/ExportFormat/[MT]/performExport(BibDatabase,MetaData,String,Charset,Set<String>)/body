{
  File outFile=new File(file);
  SaveSession ss=null;
  if (this.encoding != null) {
    try {
      ss=getSaveSession(this.encoding,outFile);
    }
 catch (    IOException ex) {
      LOGGER.warn("Can not get save session.",ex);
    }
  }
  if (ss == null) {
    ss=getSaveSession(enc,outFile);
  }
  try (VerifyingWriter ps=ss.getWriter()){
    Layout beginLayout=null;
    Globals.prefs.customExportNameFormatters=readFormatterFile(lfFileName);
    List<String> missingFormatters=new ArrayList<>(1);
    try (Reader reader=getReader(lfFileName + ".begin.layout")){
      LayoutHelper layoutHelper=new LayoutHelper(reader);
      beginLayout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
    }
 catch (    IOException ex) {
    }
    if (beginLayout != null) {
      ps.write(beginLayout.doLayout(database,enc));
      missingFormatters.addAll(beginLayout.getMissingFormatters());
    }
    List<BibEntry> sorted=FileActions.getSortedEntries(database,metaData,entryIds,false);
    Layout defLayout;
    LayoutHelper layoutHelper;
    try (Reader reader=getReader(lfFileName + ".layout")){
      layoutHelper=new LayoutHelper(reader);
      defLayout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
    }
     if (defLayout != null) {
      missingFormatters.addAll(defLayout.getMissingFormatters());
      if (!missingFormatters.isEmpty()) {
        LOGGER.warn(missingFormatters);
      }
    }
    HashMap<String,Layout> layouts=new HashMap<>();
    Layout layout;
    ExportFormats.entryNumber=0;
    for (    BibEntry entry : sorted) {
      ExportFormats.entryNumber++;
      String type=entry.getType();
      if (layouts.containsKey(type)) {
        layout=layouts.get(type);
      }
 else {
        try (Reader reader=getReader(lfFileName + '.' + type+ ".layout")){
          layoutHelper=new LayoutHelper(reader);
          layout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
          layouts.put(type,layout);
          if (layout != null) {
            missingFormatters.addAll(layout.getMissingFormatters());
          }
        }
 catch (        IOException ex) {
          layout=defLayout;
        }
      }
      ps.write(layout.doLayout(entry,database));
    }
    Layout endLayout=null;
    try (Reader reader=getReader(lfFileName + ".end.layout")){
      layoutHelper=new LayoutHelper(reader);
      endLayout=layoutHelper.getLayoutFromText(Globals.FORMATTER_PACKAGE);
    }
 catch (    IOException ex) {
    }
    if (endLayout != null) {
      ps.write(endLayout.doLayout(database,encoding));
      missingFormatters.addAll(endLayout.getMissingFormatters());
    }
    Globals.prefs.customExportNameFormatters=null;
    if (!missingFormatters.isEmpty()) {
      StringBuilder sb=new StringBuilder("The following formatters could not be found: ");
      for (Iterator<String> i=missingFormatters.iterator(); i.hasNext(); ) {
        sb.append(i.next());
        if (i.hasNext()) {
          sb.append(", ");
        }
      }
      LOGGER.warn(sb);
    }
    finalizeSaveSession(ss);
  }
 }
