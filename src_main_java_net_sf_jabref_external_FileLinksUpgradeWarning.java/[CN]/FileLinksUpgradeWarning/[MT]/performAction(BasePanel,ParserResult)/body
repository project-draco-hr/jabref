{
  boolean offerChangeSettings=!Globals.prefs.getBoolean(JabRefPreferences.FILE_COLUMN) || !showsFileInGenFields();
  boolean offerChangeDatabase=linksFound(pr.getDatabase(),FileLinksUpgradeWarning.FIELDS_TO_LOOK_FOR);
  boolean offerSetFileDir=!Globals.prefs.hasKey(GUIGlobals.FILE_FIELD + "Directory") && (Globals.prefs.hasKey("pdfDirectory") || Globals.prefs.hasKey("psDirectory"));
  if (!offerChangeDatabase && !offerChangeSettings && !offerSetFileDir) {
    return;
  }
  JCheckBox changeSettings=new JCheckBox(Globals.lang("Change table column and General fields settings to use the new feature"),offerChangeSettings);
  JCheckBox changeDatabase=new JCheckBox(Globals.lang("Upgrade old external file links to use the new feature"),offerChangeDatabase);
  JCheckBox setFileDir=new JCheckBox(Globals.lang("Set main external file directory") + ":",offerSetFileDir);
  JTextField fileDir=new JTextField(30);
  JCheckBox doNotShowDialog=new JCheckBox(Globals.lang("Do not show these options in the future"),false);
  JPanel message=new JPanel();
  DefaultFormBuilder b=new DefaultFormBuilder(new FormLayout("left:pref",""),message);
  b.append(new JLabel("<html>" + Globals.lang("This database was written using an older version of JabRef.") + "<br>"+ Globals.lang("The current version features a new way of handling links to external files.<br>To take advantage of this, your links must be changed into the new format, and<br>JabRef must be configured to show the new links.")+ "<p>"+ Globals.lang("Do you want JabRef to do the following operations?")+ "</html>"));
  b.nextLine();
  if (offerChangeSettings) {
    b.append(changeSettings);
    b.nextLine();
  }
  if (offerChangeDatabase) {
    b.append(changeDatabase);
    b.nextLine();
  }
  if (offerSetFileDir) {
    if (Globals.prefs.hasKey("pdfDirectory")) {
      fileDir.setText(Globals.prefs.get("pdfDirectory"));
    }
 else {
      fileDir.setText(Globals.prefs.get("psDirectory"));
    }
    JPanel pan=new JPanel();
    pan.add(setFileDir);
    pan.add(fileDir);
    JButton browse=new JButton(Globals.lang("Browse"));
    browse.addActionListener(BrowseAction.buildForDir(fileDir));
    pan.add(browse);
    b.append(pan);
    b.nextLine();
  }
  b.append("");
  b.nextLine();
  b.append(doNotShowDialog);
  int answer=JOptionPane.showConfirmDialog(panel.frame(),message,Globals.lang("Upgrade file"),JOptionPane.YES_NO_OPTION);
  if (doNotShowDialog.isSelected()) {
    Globals.prefs.putBoolean(JabRefPreferences.SHOW_FILE_LINKS_UPGRADE_WARNING,false);
  }
  if (answer == JOptionPane.YES_OPTION) {
    makeChanges(panel,pr,changeSettings.isSelected(),changeDatabase.isSelected(),setFileDir.isSelected() ? fileDir.getText() : null);
  }
}
