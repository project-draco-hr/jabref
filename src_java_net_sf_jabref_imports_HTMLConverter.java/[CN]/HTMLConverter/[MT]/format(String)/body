{
  if (text == null)   return null;
  StringBuffer sb=new StringBuffer();
  for (int i=0; i < text.length(); i++) {
    int c=text.charAt(i);
    if (c == '<') {
      i=readTag(text,sb,i);
    }
 else     sb.append((char)c);
  }
  text=sb.toString();
  Set<String> patterns=escapedSymbols.keySet();
  for (  String pattern : patterns) {
    text=text.replaceAll(pattern,escapedSymbols.get(pattern));
  }
  Pattern escapedPattern=Pattern.compile("&#([x]*\\p{XDigit}+);");
  Matcher m=escapedPattern.matcher(text);
  while (m.find()) {
    int num=Integer.decode(m.group(1).replace("x","#"));
switch (num) {
case 37:
      text=text.replaceAll("&#" + m.group(1) + ";","%");
    break;
case 38:
  text=text.replaceAll("&#" + m.group(1) + ";","&");
break;
case 916:
text=text.replaceAll("&#" + m.group(1) + ";","\\$\\\\delta\\$");
break;
case 956:
case 181:
text=text.replaceAll("&#" + m.group(1) + ";","\\$\\\\mu\\$");
break;
case 8208:
text=text.replaceAll("&#" + m.group(1) + ";","-");
break;
case 8211:
text=text.replaceAll("&#" + m.group(1) + ";","--");
break;
case 8212:
text=text.replaceAll("&#" + m.group(1) + ";","---");
break;
case 8217:
text=text.replaceAll("&#" + m.group(1) + ";","'");
break;
case 8730:
text=text.replaceAll("&#" + m.group(1) + ";","\\$\\\\sqrt{}\\$");
break;
default :
System.err.println("HTML escaped char not converted " + m.group(1) + ": "+ Integer.toString(num));
}
}
escapedPattern=Pattern.compile("&(\\w+);");
m=escapedPattern.matcher(text);
while (m.find()) {
String match=m.group(1).toLowerCase();
if (match.equals("mu")) text=text.replaceAll("&" + m.group(1) + ";","\\$\\\\mu\\$");
 else if (match.equals("radic")) text=text.replaceAll("&" + m.group(1) + ";","\\$\\\\sqrt{}\\$");
 else System.err.println("HTML escaped char not converted " + m.group(1));
}
return text.trim();
}
