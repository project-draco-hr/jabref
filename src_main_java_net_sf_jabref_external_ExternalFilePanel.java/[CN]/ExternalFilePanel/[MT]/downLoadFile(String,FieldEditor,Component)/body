{
  final String res=JOptionPane.showInputDialog(parent,Localization.lang("Enter URL to download"));
  if ((res == null) || res.trim().isEmpty()) {
    return;
  }
  final BibEntry targetEntry;
  if (entryEditor != null) {
    targetEntry=entryEditor.getEntry();
  }
 else {
    targetEntry=entry;
  }
  JabRefExecutorService.INSTANCE.execute(new Runnable(){
    public String getPlannedFileName(    String result){
      String suffix=off.getSuffix(result);
      if (suffix == null) {
        suffix='.' + fieldName.toLowerCase();
      }
      String plannedName;
      if (getKey() != null) {
        plannedName=getKey() + suffix;
      }
 else {
        plannedName=JOptionPane.showInputDialog(parent,Localization.lang("BibTeX key not set. Enter a name for the downloaded file"));
        if ((plannedName != null) && !off.accept(plannedName)) {
          plannedName+=suffix;
        }
      }
      if (plannedName != null) {
        if (OS.WINDOWS) {
          plannedName=plannedName.replaceAll("\\?|\\*|\\<|\\>|\\||\\\"|\\:|\\.$|\\[|\\]","");
        }
 else         if (OS.OS_X) {
          plannedName=plannedName.replace(":","");
        }
      }
      return plannedName;
    }
    @Override public void run(){
      String originalText=fieldEditor.getText();
      fieldEditor.setEnabled(false);
      boolean updateEditor=true;
      try {
        fieldEditor.setText(Localization.lang("Downloading..."));
        output(Localization.lang("Downloading..."));
        String plannedName=getPlannedFileName(res);
        List<String> dirs=metaData.getFileDirectory(fieldName);
        String directory=null;
        for (        String dir : dirs) {
          if (new File(dir).exists()) {
            directory=dir;
            break;
          }
        }
        if (directory == null) {
          if (dirs.size() > 0) {
            JOptionPane.showMessageDialog(parent,Localization.lang("Could not find directory for %0-files: %1",fieldName,dirs.get(0)),Localization.lang("Download file"),JOptionPane.ERROR_MESSAGE);
          }
 else {
            JOptionPane.showMessageDialog(parent,Localization.lang("No directory defined for %0-files",fieldName),Localization.lang("Download file"),JOptionPane.ERROR_MESSAGE);
          }
          return;
        }
        File file=new File(new File(directory),plannedName);
        URL url=new URL(res);
        try {
          MonitoredURLDownload.buildMonitoredDownload(parent,url).downloadToFile(file);
        }
 catch (        IOException e2) {
          JOptionPane.showMessageDialog(parent,Localization.lang("Invalid URL") + ": " + e2.getMessage(),Localization.lang("Download file"),JOptionPane.ERROR_MESSAGE);
          LOGGER.info("Error while downloading " + url,e2);
          return;
        }
        output(Localization.lang("Download completed"));
        String textToSet=file.getPath();
        if (textToSet.startsWith(directory)) {
          textToSet=textToSet.substring(directory.length(),textToSet.length());
          if (textToSet.startsWith(File.separator)) {
            textToSet=textToSet.substring(File.separator.length());
          }
        }
        if ((entryEditor == null) || (entryEditor.getEntry() != targetEntry)) {
          targetEntry.setField(fieldName,textToSet);
          fieldEditor.setText(textToSet);
          fieldEditor.setEnabled(true);
          updateEditor=false;
        }
 else {
          fieldEditor.setText(textToSet);
          fieldEditor.setEnabled(true);
          updateEditor=false;
          SwingUtilities.invokeLater(new Runnable(){
            @Override public void run(){
              entryEditor.updateField(fieldEditor);
            }
          }
);
        }
      }
 catch (      MalformedURLException e1) {
        JOptionPane.showMessageDialog(parent,Localization.lang("Invalid URL"),Localization.lang("Download file"),JOptionPane.ERROR_MESSAGE);
      }
 finally {
        if (updateEditor) {
          fieldEditor.setText(originalText);
          fieldEditor.setEnabled(true);
        }
      }
    }
  }
);
}
