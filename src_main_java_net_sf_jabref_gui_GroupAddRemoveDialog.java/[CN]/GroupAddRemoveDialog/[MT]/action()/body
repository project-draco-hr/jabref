{
  GroupTreeNode groups=panel.metaData().getGroups();
  if (groups == null) {
    return;
  }
  selection=panel.getSelectedEntries();
  final JDialog diag=new JDialog(panel.frame(),(add ? (move ? Localization.lang("Move to group") : Localization.lang("Add to group")) : Localization.lang("Remove from group")),true);
  ok=new JButton(Localization.lang("OK"));
  JButton cancel=new JButton(Localization.lang("Cancel"));
  tree=new JTree(groups);
  tree.setCellRenderer(new AddRemoveGroupTreeCellRenderer());
  tree.setVisibleRowCount(22);
  tree.getSelectionModel().setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION);
  tree.addTreeSelectionListener(new SelectionListener());
  JButton jbExpandAll=new JButton("Expand All");
  jbExpandAll.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      expandAll(tree,true);
    }
  }
);
  JButton jbCollapseAll=new JButton("Collapse All");
  jbCollapseAll.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      expandAll(tree,false);
    }
  }
);
  ButtonBarBuilder bb=new ButtonBarBuilder();
  bb.addGlue();
  bb.addButton(ok);
  bb.addButton(cancel);
  bb.addButton(jbExpandAll);
  bb.addButton(jbCollapseAll);
  bb.addGlue();
  bb.getPanel().setBorder(BorderFactory.createEmptyBorder(5,5,5,5));
  ok.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent actionEvent){
      if (doAddOrRemove()) {
        diag.dispose();
      }
    }
  }
);
  cancel.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent actionEvent){
      diag.dispose();
    }
  }
);
  ok.setEnabled(false);
  JScrollPane sp=new JScrollPane(tree);
  ActionMap am=sp.getActionMap();
  InputMap im=sp.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);
  im.put(Globals.prefs.getKey(KeyBinds.CLOSE_DIALOG),"close");
  am.put("close",new AbstractAction(){
    @Override public void actionPerformed(    ActionEvent e){
      diag.dispose();
    }
  }
);
  diag.getContentPane().add(sp,BorderLayout.CENTER);
  diag.getContentPane().add(bb.getPanel(),BorderLayout.SOUTH);
  diag.pack();
  diag.setLocationRelativeTo(panel.frame());
  diag.setVisible(true);
}
