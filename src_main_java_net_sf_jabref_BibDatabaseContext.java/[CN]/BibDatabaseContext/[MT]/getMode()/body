{
  Optional<BibDatabaseMode> mode=metaData.getMode();
  if (!mode.isPresent()) {
    BibDatabaseMode inferredMode=BibDatabaseModeDetection.inferMode(database);
    if ((defaults.mode == BibDatabaseMode.BIBLATEX) || (inferredMode == BibDatabaseMode.BIBLATEX)) {
      return BibDatabaseMode.BIBLATEX;
    }
 else {
      return BibDatabaseMode.BIBTEX;
    }
  }
  return mode.get();
}
