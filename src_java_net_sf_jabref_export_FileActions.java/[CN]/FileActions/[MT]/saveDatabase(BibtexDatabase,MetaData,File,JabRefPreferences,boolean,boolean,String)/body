{
  BibtexEntry be=null;
  try {
    initFile(file,prefs.getBoolean("backup"));
    Writer fw=getWriter(file,encoding);
    writeBibFileHeader(fw,encoding);
    writePreamble(fw,database.getPreamble());
    writeStrings(fw,database);
    String pri, sec, ter;
    boolean priD, secD, terD;
    if (!prefs.getBoolean("saveInStandardOrder")) {
      pri=prefs.get("priSort");
      sec=prefs.get("secSort");
      ter=prefs.get("terSort");
      priD=prefs.getBoolean("priDescending");
      secD=prefs.getBoolean("secDescending");
      terD=prefs.getBoolean("terDescending");
    }
 else {
      pri="author";
      sec="editor";
      ter="year";
      priD=false;
      secD=false;
      terD=true;
    }
    TreeSet sorter=new TreeSet(new CrossRefEntryComparator(new EntryComparator(priD,secD,terD,pri,sec,ter)));
    Set keySet=database.getKeySet();
    if (keySet != null) {
      Iterator i=keySet.iterator();
      for (; i.hasNext(); ) {
        sorter.add(database.getEntryById((String)(i.next())));
      }
    }
    FieldFormatter ff=new LatexFieldFormatter();
    for (Iterator i=sorter.iterator(); i.hasNext(); ) {
      be=(BibtexEntry)(i.next());
      boolean write=true;
      if (checkSearch && !nonZeroField(be,Globals.SEARCH)) {
        write=false;
      }
      if (checkGroup && !nonZeroField(be,Globals.GROUPSEARCH)) {
        write=false;
      }
      if (write) {
        be.write(fw,ff,true);
        fw.write("\n");
      }
    }
    if (metaData != null) {
      metaData.writeMetaData(fw);
    }
    fw.close();
  }
 catch (  Throwable ex) {
    repairAfterError(file);
    throw new SaveException(ex.getMessage(),be);
  }
}
