{
  int prevMarkLevel;
  String newValue=null;
  if (be.hasField(InternalBibtexFields.MARKED)) {
    String markerString=be.getFieldOptional(InternalBibtexFields.MARKED).get();
    int index=markerString.indexOf(Globals.prefs.WRAPPED_USERNAME);
    if (index >= 0) {
      prevMarkLevel=1;
      newValue=markerString.substring(0,index) + markerString.substring(index + Globals.prefs.WRAPPED_USERNAME.length()) + Globals.prefs.WRAPPED_USERNAME.substring(0,Globals.prefs.WRAPPED_USERNAME.length() - 1)+ ":"+ (increment ? Math.min(MAX_MARKING_LEVEL,prevMarkLevel + markIncrement) : markIncrement)+ "]";
    }
 else {
      Matcher m=MARK_NUMBER_PATTERN.matcher(markerString);
      if (m.find()) {
        try {
          prevMarkLevel=Integer.parseInt(m.group(1));
          newValue=markerString.substring(0,m.start(1)) + (increment ? Math.min(MAX_MARKING_LEVEL,prevMarkLevel + markIncrement) : markIncrement) + markerString.substring(m.end(1));
        }
 catch (        NumberFormatException ex) {
        }
      }
    }
  }
  if (newValue == null) {
    newValue=Globals.prefs.WRAPPED_USERNAME.substring(0,Globals.prefs.WRAPPED_USERNAME.length() - 1) + ":" + markIncrement+ "]";
  }
  ce.addEdit(new UndoableFieldChange(be,InternalBibtexFields.MARKED,be.getFieldOptional(InternalBibtexFields.MARKED).orElse(null),newValue));
  be.setField(InternalBibtexFields.MARKED,newValue);
}
