{
  if (be.hasField(FieldName.MARKED)) {
    String markerString=be.getFieldOptional(FieldName.MARKED).get();
    if ("0".equals(markerString)) {
      if (!onlyMaxLevel) {
        unmarkOldStyle(be,database,ce);
      }
      return;
    }
    String newValue=null;
    int index=markerString.indexOf(Globals.prefs.WRAPPED_USERNAME);
    if (index >= 0) {
      if (onlyMaxLevel) {
        return;
      }
 else {
        newValue=markerString.substring(0,index) + markerString.substring(index + Globals.prefs.WRAPPED_USERNAME.length());
      }
    }
 else {
      Matcher m=MARK_NUMBER_PATTERN.matcher(markerString);
      if (m.find()) {
        try {
          int prevMarkLevel=Integer.parseInt(m.group(1));
          if (!onlyMaxLevel || (prevMarkLevel == MARK_COLOR_LEVELS)) {
            if (prevMarkLevel > 1) {
              newValue=markerString.substring(0,m.start(1)) + markerString.substring(m.end(1));
            }
 else {
              String toRemove=Globals.prefs.WRAPPED_USERNAME.substring(0,Globals.prefs.WRAPPED_USERNAME.length() - 1) + ":1]";
              index=markerString.indexOf(toRemove);
              if (index >= 0) {
                newValue=markerString.substring(0,index) + markerString.substring(index + toRemove.length());
              }
            }
          }
 else {
            return;
          }
        }
 catch (        NumberFormatException ex) {
        }
      }
    }
    ce.addEdit(new UndoableFieldChange(be,FieldName.MARKED,be.getFieldOptional(FieldName.MARKED).get(),newValue));
    if (newValue == null) {
      be.clearField(FieldName.MARKED);
    }
 else {
      be.setField(FieldName.MARKED,newValue);
    }
  }
}
