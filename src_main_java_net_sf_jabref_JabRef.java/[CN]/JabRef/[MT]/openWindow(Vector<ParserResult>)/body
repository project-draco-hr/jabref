{
  PreferencesMigrations.performCompatibilityUpdate();
  PreferencesMigrations.upgradeFaultyEncodingStrings();
  Globals.prefs.updateExternalFileTypes();
  System.setProperty("apple.laf.useScreenMenuBar","true");
  System.setProperty("swing.aatext","true");
  System.setProperty("awt.useSystemAAFontSettings","lcd");
  try {
    setLookAndFeel();
  }
 catch (  Throwable e) {
    e.printStackTrace();
  }
  if (!cli.isBlank() && Globals.prefs.getBoolean(JabRefPreferences.OPEN_LAST_EDITED) && Globals.prefs.get(JabRefPreferences.LAST_EDITED) != null) {
    String[] names=Globals.prefs.getStringArray(JabRefPreferences.LAST_EDITED);
    lastEdLoop:     for (    String name : names) {
      File fileToOpen=new File(name);
      for (int j=0; j < loaded.size(); j++) {
        ParserResult pr=loaded.elementAt(j);
        if (pr.getFile() != null && pr.getFile().equals(fileToOpen)) {
          continue lastEdLoop;
        }
      }
      if (fileToOpen.exists()) {
        ParserResult pr=JabRef.openBibFile(name,false);
        if (pr != null) {
          if (pr == ParserResult.INVALID_FORMAT) {
            System.out.println(Localization.lang("Error opening file") + " '" + fileToOpen.getPath()+ "'");
          }
 else           if (pr != ParserResult.FILE_LOCKED) {
            loaded.add(pr);
          }
        }
      }
    }
  }
  GUIGlobals.init();
  GUIGlobals.CURRENTFONT=new Font(Globals.prefs.get(JabRefPreferences.FONT_FAMILY),Globals.prefs.getInt(JabRefPreferences.FONT_STYLE),Globals.prefs.getInt(JabRefPreferences.FONT_SIZE));
  JabRef.jrf=new JabRefFrame(this);
  boolean first=true;
  List<File> postponed=new ArrayList<File>();
  List<ParserResult> failed=new ArrayList<ParserResult>();
  List<ParserResult> toOpenTab=new ArrayList<ParserResult>();
  if (!loaded.isEmpty()) {
    for (Iterator<ParserResult> i=loaded.iterator(); i.hasNext(); ) {
      ParserResult pr=i.next();
      if (pr.isInvalid()) {
        failed.add(pr);
        i.remove();
      }
 else       if (!pr.isPostponedAutosaveFound()) {
        if (pr.toOpenTab()) {
          toOpenTab.add(pr);
        }
 else {
          JabRef.jrf.addParserResult(pr,first);
          first=false;
        }
      }
 else {
        i.remove();
        postponed.add(pr.getFile());
      }
    }
  }
  for (  ParserResult pr : toOpenTab) {
    JabRef.jrf.addParserResult(pr,first);
    first=false;
  }
  if (cli.isLoadSession()) {
    JabRef.jrf.loadSessionAction.actionPerformed(new java.awt.event.ActionEvent(JabRef.jrf,0,""));
  }
  if (Globals.prefs.getBoolean(JabRefPreferences.AUTO_SAVE)) {
    Globals.startAutoSaveManager(JabRef.jrf);
  }
  if (Globals.prefs.getBoolean(JabRefPreferences.WINDOW_MAXIMISED)) {
    JabRef.jrf.setExtendedState(JFrame.MAXIMIZED_BOTH);
  }
  JabRef.jrf.setVisible(true);
  if (Globals.prefs.getBoolean(JabRefPreferences.WINDOW_MAXIMISED)) {
    JabRef.jrf.setExtendedState(JFrame.MAXIMIZED_BOTH);
  }
  for (  ParserResult pr : failed) {
    String message="<html>" + Localization.lang("Error opening file '%0'.",pr.getFile().getName()) + "<p>"+ pr.getErrorMessage()+ "</html>";
    JOptionPane.showMessageDialog(JabRef.jrf,message,Localization.lang("Error opening file"),JOptionPane.ERROR_MESSAGE);
  }
  for (int i=0; i < loaded.size(); i++) {
    ParserResult pr=loaded.elementAt(i);
    if (Globals.prefs.getBoolean(JabRefPreferences.DISPLAY_KEY_WARNING_DIALOG_AT_STARTUP) && pr.hasWarnings()) {
      String[] wrns=pr.warnings();
      StringBuilder wrn=new StringBuilder();
      for (int j=0; j < Math.min(JabRef.MAX_DIALOG_WARNINGS,wrns.length); j++) {
        wrn.append(j + 1).append(". ").append(wrns[j]).append("\n");
      }
      if (wrns.length > JabRef.MAX_DIALOG_WARNINGS) {
        wrn.append("... ");
        wrn.append(Localization.lang("%0 warnings",String.valueOf(wrns.length)));
      }
 else       if (wrn.length() > 0) {
        wrn.deleteCharAt(wrn.length() - 1);
      }
      JabRef.jrf.showBaseAt(i);
      JOptionPane.showMessageDialog(JabRef.jrf,wrn.toString(),Localization.lang("Warnings") + " (" + pr.getFile().getName()+ ")",JOptionPane.WARNING_MESSAGE);
    }
  }
  for (int i=0; i < loaded.size() && i < JabRef.jrf.baseCount(); i++) {
    ParserResult pr=loaded.elementAt(i);
    BasePanel panel=JabRef.jrf.baseAt(i);
    OpenDatabaseAction.performPostOpenActions(panel,pr,true);
  }
  if (!postponed.isEmpty()) {
    AutosaveStartupPrompter asp=new AutosaveStartupPrompter(JabRef.jrf,postponed);
    SwingUtilities.invokeLater(asp);
  }
  if (!loaded.isEmpty()) {
    JabRef.jrf.tabbedPane.setSelectedIndex(0);
    new FocusRequester(((BasePanel)JabRef.jrf.tabbedPane.getComponentAt(0)).mainTable);
  }
}
