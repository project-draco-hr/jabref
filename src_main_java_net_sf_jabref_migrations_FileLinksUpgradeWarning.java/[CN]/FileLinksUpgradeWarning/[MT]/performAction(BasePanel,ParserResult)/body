{
  boolean offerChangeSettings=!Globals.prefs.getBoolean(JabRefPreferences.FILE_COLUMN) || !showsFileInGenFields();
  boolean offerChangeDatabase=linksFound(pr.getDatabase(),FileLinksUpgradeWarning.FIELDS_TO_LOOK_FOR);
  boolean offerSetFileDir=!Globals.prefs.hasKey(GUIGlobals.FILE_FIELD + "Directory") && (Globals.prefs.hasKey("pdfDirectory") || Globals.prefs.hasKey("psDirectory"));
  if (!offerChangeDatabase && !offerChangeSettings && !offerSetFileDir) {
    return;
  }
  JCheckBox changeSettings=new JCheckBox(Localization.lang("Change table column and General fields settings to use the new feature"),offerChangeSettings);
  JCheckBox changeDatabase=new JCheckBox(Localization.lang("Upgrade old external file links to use the new feature"),offerChangeDatabase);
  JCheckBox setFileDir=new JCheckBox(Localization.lang("Set main external file directory") + ":",offerSetFileDir);
  JTextField fileDir=new JTextField(30);
  JCheckBox doNotShowDialog=new JCheckBox(Localization.lang("Do not show these options in the future"),false);
  JPanel message=new JPanel();
  FormBuilder b=FormBuilder.create().layout(new FormLayout("left:pref","p"));
  int row=1;
  b.add(new JLabel("<html>" + Localization.lang("This database was written using an older version of JabRef.") + "<br>"+ Localization.lang("The current version features a new way of handling links to external files.<br>To take advantage of this, your links must be changed into the new format, and<br>JabRef must be configured to show the new links.")+ "<p>"+ Localization.lang("Do you want JabRef to do the following operations?")+ "</html>")).xy(1,row);
  if (offerChangeSettings) {
    b.appendRows("2dlu, p");
    row+=2;
    b.add(changeSettings).xy(1,row);
  }
  if (offerChangeDatabase) {
    b.appendRows("2dlu, p");
    row+=2;
    b.add(changeDatabase).xy(1,row);
  }
  if (offerSetFileDir) {
    if (Globals.prefs.hasKey("pdfDirectory")) {
      fileDir.setText(Globals.prefs.get("pdfDirectory"));
    }
 else {
      fileDir.setText(Globals.prefs.get("psDirectory"));
    }
    JPanel pan=new JPanel();
    pan.add(setFileDir);
    pan.add(fileDir);
    JButton browse=new JButton(Localization.lang("Browse"));
    browse.addActionListener(BrowseAction.buildForDir(fileDir));
    pan.add(browse);
    b.appendRows("2dlu, p");
    row+=2;
    b.add(pan).xy(1,row);
  }
  b.appendRows("6dlu, p");
  b.add(doNotShowDialog).xy(1,row + 2);
  message.add(b.build());
  int answer=JOptionPane.showConfirmDialog(panel.frame(),message,Localization.lang("Upgrade file"),JOptionPane.YES_NO_OPTION);
  if (doNotShowDialog.isSelected()) {
    Globals.prefs.putBoolean(JabRefPreferences.SHOW_FILE_LINKS_UPGRADE_WARNING,false);
  }
  if (answer == JOptionPane.YES_OPTION) {
    makeChanges(panel,pr,changeSettings.isSelected(),changeDatabase.isSelected(),setFileDir.isSelected() ? fileDir.getText() : null);
  }
}
