{
  couldNotConnect=false;
  couldNotCall=false;
  notDefined=false;
  initParameters();
  commandPath=Globals.prefs.get(commandPathPreferenceKey);
  if ((commandPath == null) || commandPath.trim().isEmpty()) {
    notDefined=true;
    return;
  }
  commandPath=Globals.prefs.get(commandPathPreferenceKey);
  String[] addParams=Globals.prefs.get(JabRefPreferences.EMACS_ADDITIONAL_PARAMETERS).split(" ");
  try {
    String[] com=new String[addParams.length + 2];
    com[0]=commandPath;
    System.arraycopy(addParams,0,com,1,addParams.length);
    String prefix;
    String suffix;
    if (Globals.prefs.getBoolean(JabRefPreferences.EMACS_23)) {
      prefix="(with-current-buffer (window-buffer) (insert ";
      suffix="))";
    }
 else {
      prefix="(insert ";
      suffix=")";
    }
    com[com.length - 1]=OS.WINDOWS ? prefix.concat("\\\"\\" + citeCommand.replaceAll("\\\\","\\\\\\\\") + "{"+ keys+ "}\\\"").concat(suffix) : prefix.concat("\"" + citeCommand.replaceAll("\\\\","\\\\\\\\") + "{"+ keys+ "}\"").concat(suffix);
    final Process p=Runtime.getRuntime().exec(com);
    Runnable errorListener=new Runnable(){
      @Override public void run(){
        try (InputStream out=p.getErrorStream()){
          int c;
          StringBuilder sb=new StringBuilder();
          try {
            while ((c=out.read()) != -1) {
              sb.append((char)c);
            }
          }
 catch (          IOException e) {
            LOGGER.warn("Could not read from stderr.");
          }
          if (!sb.toString().trim().isEmpty()) {
            LOGGER.warn("Push to Emacs error: " + sb);
            couldNotConnect=true;
          }
        }
 catch (        IOException e) {
          LOGGER.warn("File problem.",e);
        }
      }
    }
;
    JabRefExecutorService.INSTANCE.executeAndWait(errorListener);
  }
 catch (  IOException excep) {
    couldNotCall=true;
  }
}
