{
  boolean close=true;
  Vector<String> filenames=new Vector<String>();
  if (tabbedPane.getTabCount() > 0) {
    for (int i=0; i < tabbedPane.getTabCount(); i++) {
      if (baseAt(i).baseChanged) {
        tabbedPane.setSelectedIndex(i);
        int answer=JOptionPane.showConfirmDialog(JabRefFrame.this,Globals.lang("Database has changed. Do you " + "want to save before closing?"),Globals.lang("Save before closing"),JOptionPane.YES_NO_CANCEL_OPTION);
        if ((answer == JOptionPane.CANCEL_OPTION) || (answer == JOptionPane.CLOSED_OPTION)) {
          close=false;
          return;
        }
        if (answer == JOptionPane.YES_OPTION) {
          try {
            SaveDatabaseAction saveAction=new SaveDatabaseAction(basePanel());
            saveAction.runCommand();
            if (saveAction.isCancelled() || !saveAction.isSuccess()) {
              output(Globals.lang("Unable to save database"));
              close=false;
            }
          }
 catch (          Throwable ex) {
            close=false;
            break;
          }
        }
      }
      if (baseAt(i).getFile() != null) {
        filenames.add(baseAt(i).getFile().getAbsolutePath());
      }
    }
  }
  if (close) {
    for (int i=0; i < tabbedPane.getTabCount(); i++) {
      if (baseAt(i).isSaving()) {
        WaitForSaveOperation w=new WaitForSaveOperation(this);
        w.show();
        if (w.cancelled())         return;
      }
    }
    dispose();
    prefs.putInt("posX",JabRefFrame.this.getLocation().x);
    prefs.putInt("posY",JabRefFrame.this.getLocation().y);
    prefs.putInt("sizeX",JabRefFrame.this.getSize().width);
    prefs.putInt("sizeY",JabRefFrame.this.getSize().height);
    prefs.putBoolean("windowMaximised",(getExtendedState() == Frame.MAXIMIZED_BOTH));
    prefs.putBoolean("rememberWindowLocation",!Globals.prefs.getBoolean("windowMaximised"));
    prefs.putBoolean("searchPanelVisible",sidePaneManager.isComponentVisible("search"));
    int width=contentPane.getDividerLocation();
    if (width > 0)     prefs.putInt("sidePaneWidth",width);
    if (prefs.getBoolean("openLastEdited")) {
      if (filenames.size() == 0) {
        prefs.remove("lastEdited");
      }
 else {
        String[] names=new String[filenames.size()];
        for (int i=0; i < filenames.size(); i++) {
          names[i]=filenames.elementAt(i);
        }
        prefs.putStringArray("lastEdited",names);
      }
    }
    fileHistory.storeHistory();
    prefs.customExports.store();
    prefs.customImports.store();
    BibtexEntryType.saveCustomEntryTypes(prefs);
    if (Globals.autoSaveManager != null)     Globals.autoSaveManager.clearAutoSaves();
    if (basePanel() != null) {
      (searchManager).updatePrefs();
    }
    prefs.flush();
    System.exit(0);
  }
}
