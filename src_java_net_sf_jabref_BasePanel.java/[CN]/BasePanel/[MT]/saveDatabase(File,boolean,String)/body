{
  SaveSession session;
  frame.block();
  try {
    if (!selectedOnly)     session=FileActions.saveDatabase(database,metaData,file,prefs,false,false,encoding);
 else     session=FileActions.savePartOfDatabase(database,metaData,file,prefs,entryTable.getSelectedEntries(),encoding);
  }
 catch (  SaveException ex) {
    if (ex.specificEntry()) {
      int row=tableModel.getNumberFromName(ex.getEntry().getId()), topShow=Math.max(0,row - 3);
      entryTable.setRowSelectionInterval(row,row);
      entryTable.setColumnSelectionInterval(0,entryTable.getColumnCount() - 1);
      entryTable.scrollTo(topShow);
      showEntry(ex.getEntry());
    }
 else     ex.printStackTrace();
    JOptionPane.showMessageDialog(frame,Globals.lang("Could not save file") + ".\n" + ex.getMessage(),Globals.lang("Save database"),JOptionPane.ERROR_MESSAGE);
    throw new SaveException("rt");
  }
 finally {
    frame.unblock();
  }
  boolean commit=true;
  if (!session.getWriter().couldEncodeAll()) {
    String warning=Globals.lang("The chosen encoding '%0' could not encode the following characters: ",session.getEncoding()) + session.getWriter().getProblemCharacters() + "\nDo you want to continue?";
    int answer=JOptionPane.showConfirmDialog(frame,warning,Globals.lang("Save database"),JOptionPane.YES_NO_OPTION);
    if (answer != JOptionPane.YES_OPTION)     commit=false;
  }
  try {
    if (commit)     session.commit();
 else     session.cancel();
  }
 catch (  IOException e) {
    e.printStackTrace();
  }
}
