{
  if (grammar instanceof LexerGrammar) {
    if (r.type != ANTLRTokenTypes.TOKEN_REF) {
      tool.error("Parser rule " + r.getText() + " referenced in lexer");
      return;
    }
    if (autoGenType == GrammarElement.AUTO_GEN_CARET) {
      tool.error("AST specification ^ not allowed in lexer",grammar.getFilename(),r.getLine());
    }
  }
  super.refRule(idAssign,r,label,args,autoGenType);
  lastRuleRef=new RuleRefElement(grammar,r,autoGenType);
  if (args != null) {
    lastRuleRef.setArgs(args.getText());
  }
  if (idAssign != null) {
    lastRuleRef.setIdAssign(idAssign.getText());
  }
  addElementToCurrentAlt(lastRuleRef);
  String id=r.getText();
  if (r.type == ANTLRTokenTypes.TOKEN_REF) {
    id=CodeGenerator.lexerRuleName(id);
  }
  RuleSymbol rs=(RuleSymbol)grammar.getSymbol(id);
  rs.addReference(lastRuleRef);
  labelElement(lastRuleRef,label);
}
