{
  Map<BibEntry,BibDatabase> correctEntries;
  if (!style.isSortByPosition()) {
    Map<BibEntry,BibDatabase> newMap=new TreeMap<>(entryComparator);
    newMap.putAll(entries);
    correctEntries=newMap;
  }
 else {
    correctEntries=entries;
  }
  int number=1;
  for (  Map.Entry<BibEntry,BibDatabase> entry : correctEntries.entrySet()) {
    if (entry.getKey() instanceof UndefinedBibtexEntry) {
      continue;
    }
    OOUtil.insertParagraphBreak(text,cursor);
    if (style.isNumberEntries()) {
      int minGroupingCount=style.getIntCitProperty(OOBibStyle.MINIMUM_GROUPING_COUNT);
      OOUtil.insertTextAtCurrentLocation(text,cursor,style.getNumCitationMarker(Arrays.asList(number++),minGroupingCount,true),new BitSet(OOUtil.TOTAL_FORMAT_COUNT));
    }
    Layout layout=style.getReferenceFormat(entry.getKey().getType());
    layout.setPostFormatter(POSTFORMATTER);
    OOUtil.insertFullReferenceAtCurrentLocation(text,cursor,layout,parFormat,entry.getKey(),entry.getValue(),uniquefiers.get(entry.getKey().getCiteKey()));
  }
}
