{
  if (!goOn) {
    return;
  }
  for (  BibEntry entry : entries) {
    List<File> files=new ArrayList<>();
    String pdf=entry.getField("pdf");
    String[] dirs=panel.metaData().getFileDirectory("pdf");
    File f=FileUtil.expandFilename(pdf,dirs);
    if (f != null) {
      files.add(f);
    }
    dirs=panel.metaData().getFileDirectory(Globals.FILE_FIELD);
    if (entry.hasField(Globals.FILE_FIELD)) {
      FileListTableModel tm=new FileListTableModel();
      tm.setContent(entry.getField(Globals.FILE_FIELD));
      for (int j=0; j < tm.getRowCount(); j++) {
        FileListEntry flEntry=tm.getEntry(j);
        if ((flEntry.getType() != null) && "pdf".equals(flEntry.getType().getName().toLowerCase())) {
          f=FileUtil.expandFilename(flEntry.getLink(),dirs);
          if (f != null) {
            files.add(f);
          }
        }
      }
    }
    optDiag.getProgressArea().append(entry.getCiteKey() + "\n");
    if (files.isEmpty()) {
      skipped++;
      optDiag.getProgressArea().append("  " + Localization.lang("Skipped - No PDF linked") + ".\n");
    }
 else {
      for (      File file : files) {
        if (!file.exists()) {
          skipped++;
          optDiag.getProgressArea().append("  " + Localization.lang("Skipped - PDF does not exist") + ":\n");
          optDiag.getProgressArea().append("    " + file.getPath() + "\n");
        }
 else {
          try {
            XMPUtil.writeXMP(file,entry,database);
            optDiag.getProgressArea().append("  " + Localization.lang("OK") + ".\n");
            entriesChanged++;
          }
 catch (          Exception e) {
            optDiag.getProgressArea().append("  " + Localization.lang("Error while writing") + " '"+ file.getPath()+ "':\n");
            optDiag.getProgressArea().append("    " + e.getLocalizedMessage() + "\n");
            errors++;
          }
        }
      }
    }
    if (optDiag.isCanceled()) {
      optDiag.getProgressArea().append("\n" + Localization.lang("Operation canceled.") + "\n");
      break;
    }
  }
  optDiag.getProgressArea().append("\n" + Localization.lang("Finished writing XMP for %0 file (%1 skipped, %2 errors).",String.valueOf(entriesChanged),String.valueOf(skipped),String.valueOf(errors)));
  optDiag.done();
}
