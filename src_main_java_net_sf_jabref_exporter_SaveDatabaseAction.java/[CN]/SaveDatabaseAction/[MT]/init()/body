{
  success=false;
  cancelled=false;
  fileLockedError=false;
  if (panel.getFile() == null) {
    saveAs();
  }
 else {
    if (panel.isUpdatedExternally() || Globals.fileUpdateMonitor.hasBeenModified(panel.getFileMonitorHandle())) {
      String[] opts=new String[]{Localization.lang("Review changes"),Localization.lang("Save"),Localization.lang("Cancel")};
      int answer=JOptionPane.showOptionDialog(panel.frame(),Localization.lang("File has been updated externally. " + "What do you want to do?"),Localization.lang("File updated externally"),JOptionPane.YES_NO_CANCEL_OPTION,JOptionPane.QUESTION_MESSAGE,null,opts,opts[0]);
      if (answer == JOptionPane.CANCEL_OPTION) {
        cancelled=true;
        return;
      }
 else       if (answer == JOptionPane.YES_OPTION) {
        cancelled=true;
        JabRefExecutorService.INSTANCE.execute(new Runnable(){
          @Override public void run(){
            if (!FileBasedLock.waitForFileLock(panel.getFile(),10)) {
              System.err.println("File locked, this will be trouble.");
            }
            ChangeScanner scanner=new ChangeScanner(panel.frame(),panel,panel.getFile());
            JabRefExecutorService.INSTANCE.executeWithLowPriorityInOwnThreadAndWait(scanner);
            if (scanner.changesFound()) {
              scanner.displayResult(new ChangeScanner.DisplayResultCallback(){
                @Override public void scanResultsResolved(                boolean resolved){
                  if (!resolved) {
                    cancelled=true;
                  }
 else {
                    panel.setUpdatedExternally(false);
                    SwingUtilities.invokeLater(new Runnable(){
                      @Override public void run(){
                        panel.getSidePaneManager().hide("fileUpdate");
                      }
                    }
);
                  }
                }
              }
);
            }
          }
        }
);
        return;
      }
 else {
        Vector<String> pd=panel.metaData().getData(Globals.PROTECTED_FLAG_META);
        boolean databaseProtectionFlag=pd != null && Boolean.parseBoolean(pd.get(0));
        if (databaseProtectionFlag) {
          JOptionPane.showMessageDialog(frame,Localization.lang("Database is protected. Cannot save until external changes have been reviewed."),Localization.lang("Protected database"),JOptionPane.ERROR_MESSAGE);
          cancelled=true;
        }
 else {
          panel.setUpdatedExternally(false);
          panel.getSidePaneManager().hide("fileUpdate");
        }
      }
    }
    panel.frame().output(Localization.lang("Saving database") + "...");
    panel.setSaving(true);
  }
}
