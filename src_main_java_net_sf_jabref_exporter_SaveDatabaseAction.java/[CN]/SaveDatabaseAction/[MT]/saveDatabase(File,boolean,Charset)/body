{
  SaveSession session;
  frame.block();
  try {
    SavePreferences prefs=new SavePreferences(Globals.prefs);
    prefs.setEncoding(encoding);
    BibDatabaseWriter databaseWriter=new BibDatabaseWriter();
    if (selectedOnly) {
      session=databaseWriter.savePartOfDatabase(panel.getBibDatabaseContext(),prefs,panel.getSelectedEntries());
    }
 else {
      session=databaseWriter.saveDatabase(panel.getBibDatabaseContext(),prefs);
    }
  }
 catch (  UnsupportedCharsetException ex2) {
    JOptionPane.showMessageDialog(frame,Localization.lang("Could not save file.") + Localization.lang("Character encoding '%0' is not supported.",encoding.displayName()),Localization.lang("Save database"),JOptionPane.ERROR_MESSAGE);
    throw new SaveException("rt");
  }
catch (  SaveException ex) {
    if (ex == SaveException.FILE_LOCKED) {
      throw ex;
    }
    if (ex.specificEntry()) {
      int row=panel.mainTable.findEntry(ex.getEntry());
      int topShow=Math.max(0,row - 3);
      panel.mainTable.setRowSelectionInterval(row,row);
      panel.mainTable.scrollTo(topShow);
      panel.showEntry(ex.getEntry());
    }
 else {
      LOGGER.error("Problem saving file",ex);
    }
    JOptionPane.showMessageDialog(frame,Localization.lang("Could not save file.") + ".\n" + ex.getMessage(),Localization.lang("Save database"),JOptionPane.ERROR_MESSAGE);
    throw new SaveException("rt");
  }
 finally {
    frame.unblock();
  }
  boolean commit=true;
  if (!session.getWriter().couldEncodeAll()) {
    FormBuilder builder=FormBuilder.create().layout(new FormLayout("left:pref, 4dlu, fill:pref","pref, 4dlu, pref"));
    JTextArea ta=new JTextArea(session.getWriter().getProblemCharacters());
    ta.setEditable(false);
    builder.add(Localization.lang("The chosen encoding '%0' could not encode the following characters:",session.getEncoding().displayName())).xy(1,1);
    builder.add(ta).xy(3,1);
    builder.add(Localization.lang("What do you want to do?")).xy(1,3);
    String tryDiff=Localization.lang("Try different encoding");
    int answer=JOptionPane.showOptionDialog(frame,builder.getPanel(),Localization.lang("Save database"),JOptionPane.YES_NO_CANCEL_OPTION,JOptionPane.WARNING_MESSAGE,null,new String[]{Localization.lang("Save"),tryDiff,Localization.lang("Cancel")},tryDiff);
    if (answer == JOptionPane.NO_OPTION) {
      Object choice=JOptionPane.showInputDialog(frame,Localization.lang("Select encoding"),Localization.lang("Save database"),JOptionPane.QUESTION_MESSAGE,null,Encodings.ENCODINGS_DISPLAYNAMES,encoding);
      if (choice == null) {
        commit=false;
      }
 else {
        Charset newEncoding=Charset.forName((String)choice);
        return saveDatabase(file,selectedOnly,newEncoding);
      }
    }
 else     if (answer == JOptionPane.CANCEL_OPTION) {
      commit=false;
    }
  }
  try {
    if (commit) {
      session.commit(file);
      panel.setEncoding(encoding);
    }
 else {
      session.cancel();
    }
  }
 catch (  SaveException e) {
    int ans=JOptionPane.showConfirmDialog(null,Localization.lang("Save failed during backup creation") + ". " + Localization.lang("Save without backup?"),Localization.lang("Unable to create backup"),JOptionPane.YES_NO_OPTION);
    if (ans == JOptionPane.YES_OPTION) {
      session.setUseBackup(false);
      session.commit(file);
      panel.setEncoding(encoding);
    }
 else {
      commit=false;
    }
  }
  return commit;
}
