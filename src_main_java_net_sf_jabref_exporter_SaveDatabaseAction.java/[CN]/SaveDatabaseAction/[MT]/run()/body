{
  if (cancelled || (panel.getBibDatabaseContext().getDatabaseFile() == null)) {
    return;
  }
  try {
    panel.storeCurrentEdit();
    panel.autoGenerateKeysBeforeSaving();
    if (FileBasedLock.waitForFileLock(panel.getBibDatabaseContext().getDatabaseFile(),10)) {
      success=saveDatabase(panel.getBibDatabaseContext().getDatabaseFile(),false,panel.getEncoding());
      try {
        Globals.fileUpdateMonitor.updateTimeStamp(panel.getFileMonitorHandle());
      }
 catch (      IllegalArgumentException ex) {
      }
    }
 else {
      success=false;
      fileLockedError=true;
    }
    panel.setSaving(false);
    if (success) {
      panel.undoManager.markUnchanged();
      if (!AutoSaveManager.deleteAutoSaveFile(panel)) {
      }
      panel.setNonUndoableChange(false);
      panel.setBaseChanged(false);
      panel.setUpdatedExternally(false);
    }
  }
 catch (  SaveException ex2) {
    if (ex2 == SaveException.FILE_LOCKED) {
      success=false;
      fileLockedError=true;
      return;
    }
    LOGGER.error("Problem saving file",ex2);
  }
}
