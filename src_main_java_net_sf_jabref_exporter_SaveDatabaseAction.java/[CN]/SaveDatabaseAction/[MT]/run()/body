{
  if (cancelled || (panel.getFile() == null)) {
    return;
  }
  try {
    panel.storeCurrentEdit();
    panel.autoGenerateKeysBeforeSaving();
    for (    BibtexEntry entry : panel.database.getEntries()) {
      AutoFormatter formatter=new AutoFormatter(entry);
      formatter.runDefaultCleanups();
    }
    if (!FileBasedLock.waitForFileLock(panel.getFile(),10)) {
      success=false;
      fileLockedError=true;
    }
 else {
      success=saveDatabase(panel.getFile(),false,panel.getEncoding());
      try {
        Globals.fileUpdateMonitor.updateTimeStamp(panel.getFileMonitorHandle());
      }
 catch (      IllegalArgumentException ex) {
      }
    }
    panel.setSaving(false);
    if (success) {
      panel.undoManager.markUnchanged();
      if (!AutoSaveManager.deleteAutoSaveFile(panel)) {
      }
      panel.setNonUndoableChange(false);
      panel.setBaseChanged(false);
      panel.setUpdatedExternally(false);
    }
  }
 catch (  SaveException ex2) {
    if (ex2 == SaveException.FILE_LOCKED) {
      success=false;
      fileLockedError=true;
      return;
    }
    ex2.printStackTrace();
  }
}
