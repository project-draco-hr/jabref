{
  String chosenFile=null;
  File f=null;
  while (f == null) {
    chosenFile=FileDialogs.getNewFile(frame,new File(Globals.prefs.get(JabRefPreferences.WORKING_DIRECTORY)),".bib",JFileChooser.SAVE_DIALOG,false,null);
    if (chosenFile == null) {
      cancelled=true;
      return;
    }
    f=new File(chosenFile);
    if (f.exists() && (JOptionPane.showConfirmDialog(frame,Localization.lang("'%0' exists. Overwrite file?",f.getName()),Localization.lang("Save database"),JOptionPane.OK_CANCEL_OPTION) != JOptionPane.OK_OPTION)) {
      f=null;
    }
  }
  if (chosenFile != null) {
    File oldFile=panel.getLoadedDatabase().getDatabaseFile();
    panel.getLoadedDatabase().getMetaData().setFile(f);
    Globals.prefs.put(JabRefPreferences.WORKING_DIRECTORY,f.getParent());
    runCommand();
    if (!success) {
      panel.getLoadedDatabase().getMetaData().setFile(oldFile);
      return;
    }
    try {
      panel.setFileMonitorHandle(Globals.fileUpdateMonitor.addUpdateListener(panel,panel.getLoadedDatabase().getDatabaseFile()));
    }
 catch (    IOException ex) {
      LOGGER.error("Problem registering file change notifications",ex);
    }
    frame.getFileHistory().newFile(panel.getLoadedDatabase().getDatabaseFile().getPath());
  }
}
