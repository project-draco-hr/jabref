{
  if ((file != null) && file.exists()) {
    File fileToLoad=file;
    frame.output(Localization.lang("Opening") + ": '" + file.getPath()+ "'");
    boolean tryingAutosave=false;
    boolean autoSaveFound=AutoSaveManager.newerAutoSaveExists(file);
    if (autoSaveFound && !Globals.prefs.getBoolean(JabRefPreferences.PROMPT_BEFORE_USING_AUTOSAVE)) {
      fileToLoad=AutoSaveManager.getAutoSaveFile(file);
      tryingAutosave=true;
    }
 else     if (autoSaveFound) {
      int answer=JOptionPane.showConfirmDialog(null,"<html>" + Localization.lang("An autosave file was found for this database. This could indicate " + "that JabRef didn't shut down cleanly last time the file was used.") + "<br>"+ Localization.lang("Do you want to recover the database from the autosave file?")+ "</html>",Localization.lang("Recover from autosave"),JOptionPane.YES_NO_OPTION);
      if (answer == JOptionPane.YES_OPTION) {
        fileToLoad=AutoSaveManager.getAutoSaveFile(file);
        tryingAutosave=true;
      }
    }
    boolean done=false;
    while (!done) {
      String fileName=file.getPath();
      Globals.prefs.put(JabRefPreferences.WORKING_DIRECTORY,file.getPath());
      if (FileBasedLock.hasLockFile(file)) {
        long modificationTIme=FileBasedLock.getLockFileTimeStamp(file);
        if ((modificationTIme != -1) && ((System.currentTimeMillis() - modificationTIme) > SaveSession.LOCKFILE_CRITICAL_AGE)) {
          int answer=JOptionPane.showConfirmDialog(null,"<html>" + Localization.lang("Error opening file") + " '"+ fileName+ "'. "+ Localization.lang("File is locked by another JabRef instance.")+ "<p>"+ Localization.lang("Do you want to override the file lock?"),Localization.lang("File locked"),JOptionPane.YES_NO_OPTION);
          if (answer == JOptionPane.YES_OPTION) {
            FileBasedLock.deleteLockFile(file);
          }
 else {
            return;
          }
        }
 else         if (!FileBasedLock.waitForFileLock(file,10)) {
          JOptionPane.showMessageDialog(null,Localization.lang("Error opening file") + " '" + fileName+ "'. "+ Localization.lang("File is locked by another JabRef instance."),Localization.lang("Error"),JOptionPane.ERROR_MESSAGE);
          return;
        }
      }
      Charset encoding=Globals.prefs.getDefaultEncoding();
      ParserResult result;
      String errorMessage=null;
      try {
        result=OpenDatabaseAction.loadDatabase(fileToLoad,encoding);
      }
 catch (      IOException ex) {
        LOGGER.error("Error loading database " + fileToLoad,ex);
        result=ParserResult.getNullResult();
      }
      if (result.isNullResult()) {
        JOptionPane.showMessageDialog(null,Localization.lang("Error opening file") + " '" + fileName+ "'",Localization.lang("Error"),JOptionPane.ERROR_MESSAGE);
        String message="<html>" + errorMessage + "<p>"+ (tryingAutosave ? Localization.lang("Error opening autosave of '%0'. Trying to load '%0' instead.",file.getName()) : "")+ "</html>";
        JOptionPane.showMessageDialog(null,message,Localization.lang("Error opening file"),JOptionPane.ERROR_MESSAGE);
        if (tryingAutosave) {
          tryingAutosave=false;
          fileToLoad=file;
        }
 else {
          done=true;
        }
        continue;
      }
 else {
        done=true;
      }
      final BasePanel panel=addNewDatabase(result,file,raisePanel);
      if (tryingAutosave) {
        panel.markNonUndoableBaseChanged();
      }
      final ParserResult finalReferenceToResult=result;
      SwingUtilities.invokeLater(new Runnable(){
        @Override public void run(){
          OpenDatabaseAction.performPostOpenActions(panel,finalReferenceToResult,true);
        }
      }
);
    }
  }
}
