{
  if (file == null) {
    return;
  }
  if (file.exists() && backup) {
    String name=file.getName();
    String path=file.getParent();
    File backupFile=new File(path,name + GUIGlobals.backupExt);
    try {
      FileUtil.copyFile(file,backupFile,true);
    }
 catch (    IOException ex) {
      ex.printStackTrace();
      throw SaveException.BACKUP_CREATION;
    }
  }
  try {
    if (useLockFile) {
      try {
        if (createLockFile()) {
          if (!FileBasedLock.waitForFileLock(file,10)) {
            throw SaveException.FILE_LOCKED;
          }
        }
      }
 catch (      IOException ex) {
        LOGGER.error("Error when creating lock file.",ex);
      }
    }
    FileUtil.copyFile(tmp,file,true);
  }
 catch (  IOException ex2) {
    throw new SaveException("Save failed while committing changes: " + ex2.getMessage());
  }
 finally {
    if (useLockFile) {
      deleteLockFile();
    }
  }
  tmp.delete();
}
