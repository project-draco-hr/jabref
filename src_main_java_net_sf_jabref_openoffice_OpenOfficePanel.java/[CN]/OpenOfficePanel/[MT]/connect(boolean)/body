{
  String ooBaseDirectory;
  if (auto) {
    AutoDetectPaths adp=new AutoDetectPaths(diag);
    if (adp.runAutodetection()) {
      autoDetected=true;
      dialogOkPressed=true;
      diag.dispose();
    }
 else     if (!adp.cancelled()) {
      JOptionPane.showMessageDialog(diag,Localization.lang("Autodetection failed"),Localization.lang("Autodetection failed"),JOptionPane.ERROR_MESSAGE);
    }
    if (!autoDetected) {
      return;
    }
    ooBaseDirectory=Globals.prefs.get(JabRefPreferences.OO_JARS_PATH);
    sOffice=Globals.prefs.get(JabRefPreferences.OO_EXECUTABLE_PATH);
  }
 else {
    showConnectDialog();
    if (!dialogOkPressed) {
      return;
    }
    String ooPath=Globals.prefs.get(JabRefPreferences.OO_PATH);
    String ooJars=Globals.prefs.get(JabRefPreferences.OO_JARS_PATH);
    sOffice=Globals.prefs.get(JabRefPreferences.OO_EXECUTABLE_PATH);
    if (OS.WINDOWS) {
      ooBaseDirectory=ooPath + "\\program\\classes";
      sOffice=ooPath + "\\program\\soffice.exe";
    }
 else     if (OS.OS_X) {
      sOffice=ooPath + "/Contents/MacOS/soffice.bin";
      ooBaseDirectory=ooPath + "/Contents/Resources/java";
    }
 else {
      ooBaseDirectory=ooJars + "/program/classes";
    }
  }
  try {
    File[] jarFiles=new File[]{new File(ooBaseDirectory,"unoil.jar"),new File(ooBaseDirectory,"jurt.jar"),new File(ooBaseDirectory,"juh.jar"),new File(ooBaseDirectory,"ridl.jar")};
    URL[] jarList=new URL[jarFiles.length];
    for (int i=0; i < jarList.length; i++) {
      if (!jarFiles[i].exists()) {
        throw new Exception("File not found: " + jarFiles[i].getPath());
      }
      jarList[i]=jarFiles[i].toURI().toURL();
    }
    addURL(jarList);
    final JDialog progDiag=new AutoDetectPaths(diag).showProgressDialog(diag,Localization.lang("Connecting"),Localization.lang("Please wait..."),false);
    getWorker().run();
    progDiag.dispose();
    diag.dispose();
    if (ooBase == null) {
      throw connectException;
    }
    if (ooBase.isConnectedToDocument()) {
      frame.output(Localization.lang("Connected to document") + ": " + ooBase.getCurrentDocumentTitle());
    }
    selectDocument.setEnabled(true);
    pushEntries.setEnabled(true);
    pushEntriesInt.setEnabled(true);
    pushEntriesEmpty.setEnabled(true);
    pushEntriesAdvanced.setEnabled(true);
    update.setEnabled(true);
    merge.setEnabled(true);
    manageCitations.setEnabled(true);
  }
 catch (  UnsatisfiedLinkError e) {
    e.printStackTrace();
    JOptionPane.showMessageDialog(frame,Localization.lang("Unable to connect. One possible reason is that JabRef " + "and OpenOffice/LibreOffice are not both running in either 32 bit mode or 64 bit mode."));
  }
catch (  Throwable e) {
    e.printStackTrace();
    JOptionPane.showMessageDialog(frame,Localization.lang("Could not connect to running OpenOffice.") + "\n" + Localization.lang("Make sure you have installed OpenOffice with Java support.")+ "\n"+ Localization.lang("If connecting manually, please verify program and library paths.")+ "\n"+ "\n"+ Localization.lang("Error message:")+ " "+ e.getMessage());
  }
}
